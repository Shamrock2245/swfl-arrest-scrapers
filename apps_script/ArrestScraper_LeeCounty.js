/**
 * Lee County Arrest Scraper (v8.4 - UPDATED FOR NEW SPREADSHEET)
 * Entry point: runLeeArrestsNow
 * - API first (variants + pagination)
 * - Direct charges API call for accurate charge/bond/court extraction
 * - Upsert by Booking_Number; safe cell lengths
 * - ENHANCED: Mugshot image embedding + Bond paid status updates
 * - BACKFILL MODE: Updates existing records with missing charge/court data
 * - Triggers + legacy shims
 * - NEW: County column support for multi-county spreadsheet
 */

// ========== CONFIG ==========
function getConfig_(){var base={SHEET_ID:'121z5R6Hpqur54GNPC8L26ccfDPLHTJc3_LU6G7IV_0E',TAB_NAME:'Lee',COUNTY_NAME:'Lee',TIMEZONE:'America/New_York',ENDPOINTS:{BASE:'https://www.sheriffleefl.org',PUBLIC_API:'/public-api/bookings',CHARGES_API:'/public-api/bookings/{id}/charges',DETAIL_PAGE:'/booking/'},DAYS_BACK:7,PAGE_SIZE:200,MAX_PAGES:50,MAX_ENRICH:100,MAX_BACKFILL:200,DETAIL_DELAY_MS:400,RETRY_LIMIT:4,BACKOFF_BASE_MS:400,MAX_EXECUTION_MS:330000,MAX_CELL_LEN:49000,BACKFILL_MODE:true,EMBED_MUGSHOTS:false};try{if(typeof CONFIG!=='undefined'&&CONFIG&&CONFIG.ARRESTS){var o=CONFIG.ARRESTS;for(var k in o)base[k]=o[k];if(o.ENDPOINTS)base.ENDPOINTS=o.ENDPOINTS}}catch(_){ }return base}
var LEE=getConfig_();

// ========== MENU & TRIGGERS ==========
function onOpen(){SpreadsheetApp.getUi().createMenu('ğŸŸ© Bail Suite').addSubMenu(SpreadsheetApp.getUi().createMenu('Arrests (Lee)').addItem('â–¶ï¸ Run now', 'runLeeArrestsNow').addItem('ğŸ”„ Backfill existing records', 'backfillExistingRecords').addItem('ğŸ–¼ï¸ Embed mugshot images', 'embedAllMugshots').addItem('â° Install hourly trigger', 'installLeeArrestsHourly').addItem('ğŸ›‘ Disable triggers', 'disableLeeArrestsTriggers')).addToUi()}
function installLeeArrestsHourly(){ScriptApp.getProjectTriggers().forEach(function(t){if(t.getHandlerFunction()==='runLeeArrestsNow')ScriptApp.deleteTrigger(t)});ScriptApp.newTrigger('runLeeArrestsNow').timeBased().everyHours(1).create();Logger.log('â° Installed hourly trigger for runLeeArrestsNow')}
function disableLeeArrestsTriggers(){var n=0;ScriptApp.getProjectTriggers().forEach(function(t){if(t.getHandlerFunction()==='runLeeArrestsNow'){ScriptApp.deleteTrigger(t);n++}});Logger.log('ğŸ›‘ Removed '+n+' trigger(s) for runLeeArrestsNow')}

// ========== ENTRY ==========
function runLeeArrestsNow(){var startMs=Date.now(),lock=LockService.getScriptLock();if(!lock.tryLock(30000)){Logger.log('ğŸš« Another run is in progress.');return}try{Logger.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');Logger.log('ğŸš¦ Starting Lee County Arrest Scraper');Logger.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');var sheet=getOrCreateTargetSheet_(),existing=loadExistingBookingNumbers_(sheet);Logger.log('ğŸ“š Existing rows: '+existing.size);var end=new Date(),start=new Date(end.getTime()-(LEE.DAYS_BACK*86400000));Logger.log('ğŸ“… Date range: '+formatDate_(start)+' to '+formatDate_(end));var arrests=fetchArrestsFromApi_(start,end);var newOnes=arrests.filter(function(a){return a&&a.bookingNumber&&!existing.has(String(a.bookingNumber).trim())});Logger.log('ğŸ“¥ Total fetched: '+arrests.length+' | New: '+newOnes.length);var elapsed=Date.now()-startMs,remaining=LEE.MAX_EXECUTION_MS-elapsed,maxEnrich=Math.min(newOnes.length,LEE.MAX_ENRICH),enriched=[];if(remaining>60000&&maxEnrich>0){Logger.log('ğŸ”¬ Enriching '+maxEnrich+' new record(s) with charges API...');enriched=enrichWithChargesApi_(newOnes.slice(0,maxEnrich))}else Logger.log('â­ï¸ Skipping enrichment (low time budget).');var finalRows=enriched.concat(newOnes.slice(maxEnrich));var startRow=0;if(finalRows.length>0){startRow=sheet.getLastRow()+1;upsertStrict_(sheet,finalRows);Logger.log('âœ… Wrote new rows: '+finalRows.length);if(LEE.EMBED_MUGSHOTS){Logger.log('ğŸ–¼ï¸ Embedding mugshots for new rows...');embedMugshotsForRange_(sheet,startRow,sheet.getLastRow())}var endRow=sheet.getLastRow();if(typeof autoScoreNewArrests==='function'){Logger.log('ğŸ“Š Auto-scoring new arrests...');try{autoScoreNewArrests(startRow,endRow)}catch(e){Logger.log('âš ï¸ Auto-scoring failed: '+e.message)}}if(typeof autoGenerateSearchLinksForNewArrests==='function'){Logger.log('ğŸ” Auto-generating search links...');try{autoGenerateSearchLinksForNewArrests(startRow,endRow)}catch(e){Logger.log('âš ï¸ Search link generation failed: '+e.message)}}if(typeof syncQualifiedArrests==='function' && typeof CONFIG!=='undefined' && CONFIG.QUALIFIED_ARRESTS && CONFIG.QUALIFIED_ARRESTS.AUTO_SYNC){Logger.log('ğŸ¯ Auto-syncing qualified arrests...');try{syncQualifiedArrests()}catch(e){Logger.log('âš ï¸ Qualified arrests sync failed: '+e.message)}}}else{Logger.log('â„¹ï¸ No new rows to write.')}if(LEE.BACKFILL_MODE){elapsed=Date.now()-startMs;remaining=LEE.MAX_EXECUTION_MS-elapsed;if(remaining>60000){Logger.log('ğŸ”„ Starting backfill mode for existing records...');backfillExistingRecords_(sheet,remaining)}else{Logger.log('â­ï¸ Skipping backfill (low time budget)')}}var duration=Math.round((Date.now()-startMs)/1000);Logger.log('â±ï¸ Total execution time: '+duration+' seconds');Logger.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•')}catch(e){Logger.log('âŒ Fatal: '+(e&&e.stack?e.stack:e));throw e}finally{lock.releaseLock()}}

// ========== BACKFILL FUNCTION ==========
function backfillExistingRecords(){var startMs=Date.now(),lock=LockService.getScriptLock();if(!lock.tryLock(30000)){Logger.log('ğŸš« Another run is in progress.');return}try{Logger.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');Logger.log('ğŸ”„ Starting Backfill Mode');Logger.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');var sheet=getOrCreateTargetSheet_();backfillExistingRecords_(sheet,LEE.MAX_EXECUTION_MS);var duration=Math.round((Date.now()-startMs)/1000);Logger.log('â±ï¸ Total execution time: '+duration+' seconds');Logger.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•')}catch(e){Logger.log('âŒ Fatal: '+(e&&e.stack?e.stack:e));throw e}finally{lock.releaseLock()}}

function backfillExistingRecords_(sheet,timeRemaining){var startMs=Date.now();var hdr=headers_();var chargesIdx=hdr.indexOf('Charges')+1;var caseNumberIdx=hdr.indexOf('Case_Number')+1;var courtDateIdx=hdr.indexOf('Court_Date')+1;var courtTimeIdx=hdr.indexOf('Court_Time')+1;var bondAmountIdx=hdr.indexOf('Bond_Amount')+1;var bondTypeIdx=hdr.indexOf('Bond_Type')+1;var bondPaidIdx=hdr.indexOf('Bond_Paid')+1;var courtTypeIdx=hdr.indexOf('Court_Type')+1;var courtLocationIdx=hdr.indexOf('Court_Location')+1;var mugshotIdx=hdr.indexOf('Mugshot_URL')+1;var bookingNumberIdx=hdr.indexOf('Booking_Number')+1;var lastRow=sheet.getLastRow();if(lastRow<2){Logger.log('â„¹ï¸ No existing records to backfill');return}Logger.log('ğŸ“Š Scanning '+lastRow+' rows for incomplete records...');var allData=sheet.getRange(2,1,lastRow-1,hdr.length).getValues();var toUpdate=[];for(var i=0;i<allData.length;i++){var row=allData[i];var bookingNumber=row[bookingNumberIdx-1];var charges=row[chargesIdx-1];var caseNumber=row[caseNumberIdx-1];var courtDate=row[courtDateIdx-1];var courtTime=row[courtTimeIdx-1];var bondPaid=row[bondPaidIdx-1];if(!bookingNumber)continue;var needsUpdate=false;if(!charges||String(charges).trim()==='')needsUpdate=true;if(!caseNumber||String(caseNumber).trim()==='')needsUpdate=true;if(!courtDate||String(courtDate).trim()==='')needsUpdate=true;if(!courtTime||String(courtTime).trim()==='')needsUpdate=true;if(!bondPaid||String(bondPaid).trim()==='')needsUpdate=true;if(needsUpdate){toUpdate.push({rowIndex:i+2,bookingNumber:String(bookingNumber).trim(),currentCharges:charges,currentCaseNumber:caseNumber,currentCourtDate:courtDate,currentCourtTime:courtTime,currentBondPaid:bondPaid})}}Logger.log('ğŸ” Found '+toUpdate.length+' records needing updates');if(toUpdate.length===0){Logger.log('âœ… All records are complete!');return}var maxToProcess=Math.min(toUpdate.length,LEE.MAX_BACKFILL);Logger.log('ğŸ”„ Processing up to '+maxToProcess+' records...');var updated=0,failed=0,skipped=0;for(var j=0;j<maxToProcess;j++){var elapsed=Date.now()-startMs;if(elapsed>timeRemaining-10000){Logger.log('â° Time limit approaching, stopping backfill');break}var record=toUpdate[j];if(j>0&&j%10===0){Logger.log('ğŸ”„ Progress: '+j+'/'+maxToProcess+' (updated: '+updated+', failed: '+failed+', skipped: '+skipped+')')}Utilities.sleep(LEE.DETAIL_DELAY_MS);try{var chargesUrl=LEE.ENDPOINTS.BASE+LEE.ENDPOINTS.CHARGES_API.replace('{id}',record.bookingNumber);var resp=httpFetch_(chargesUrl);if(!resp||resp.code!==200){Logger.log('âš ï¸ Charges API failed for booking '+record.bookingNumber+': HTTP '+(resp?resp.code:'error'));failed++;continue}var json=tryJson_(resp.text);if(!json||!Array.isArray(json)){Logger.log('âš ï¸ Invalid charges JSON for booking '+record.bookingNumber);failed++;continue}if(json.length===0){Logger.log('â„¹ï¸ No charges found for booking '+record.bookingNumber);skipped++;continue}var parsed=parseChargesFromApi_(json);var updateNeeded=false;var updates=[];if((!record.currentCharges||String(record.currentCharges).trim()==='')&&parsed.charges.length>0){var chargesStr=parsed.charges.join(' | ');sheet.getRange(record.rowIndex,chargesIdx).setValue(limitString_(chargesStr,8000));updateNeeded=true;updates.push('charges')}if((!record.currentCaseNumber||String(record.currentCaseNumber).trim()==='')&&parsed.caseNumber){sheet.getRange(record.rowIndex,caseNumberIdx).setValue(limitString_(parsed.caseNumber,100));updateNeeded=true;updates.push('case#')}if((!record.currentCourtDate||String(record.currentCourtDate).trim()==='')&&parsed.courtDate){sheet.getRange(record.rowIndex,courtDateIdx).setValue(limitString_(parsed.courtDate,50));updateNeeded=true;updates.push('court date')}if((!record.currentCourtTime||String(record.currentCourtTime).trim()==='')&&parsed.courtTime){sheet.getRange(record.rowIndex,courtTimeIdx).setValue(limitString_(parsed.courtTime,50));updateNeeded=true;updates.push('court time')}if(parsed.bondAmount){sheet.getRange(record.rowIndex,bondAmountIdx).setValue(limitString_(parsed.bondAmount,50));updateNeeded=true}if(parsed.bondType){sheet.getRange(record.rowIndex,bondTypeIdx).setValue(limitString_(parsed.bondType,50));updateNeeded=true}if(parsed.bondPaid&&(!record.currentBondPaid||String(record.currentBondPaid).trim()!==parsed.bondPaid)){sheet.getRange(record.rowIndex,bondPaidIdx).setValue(limitString_(parsed.bondPaid,20));updateNeeded=true;updates.push('bond paid status')}if(parsed.courtType){sheet.getRange(record.rowIndex,courtTypeIdx).setValue(limitString_(parsed.courtType,100));updateNeeded=true}if(parsed.courtLocation){sheet.getRange(record.rowIndex,courtLocationIdx).setValue(limitString_(parsed.courtLocation,300));updateNeeded=true}if(updateNeeded){Logger.log('âœ… Updated booking '+record.bookingNumber+': '+updates.join(', '));updated++;if(LEE.EMBED_MUGSHOTS){embedMugshotsForRange_(sheet,record.rowIndex,record.rowIndex)}}else{Logger.log('â„¹ï¸ No updates needed for booking '+record.bookingNumber);skipped++}}catch(e){Logger.log('âš ï¸ Error processing booking '+record.bookingNumber+': '+e.message);failed++}}Logger.log('âœ… Backfill complete: '+updated+' updated, '+failed+' failed, '+skipped+' skipped')}

// ========== MUGSHOT EMBEDDING ==========
function embedAllMugshots(){var lock=LockService.getScriptLock();if(!lock.tryLock(30000)){Logger.log('ğŸš« Another operation is in progress.');return}try{Logger.log('ğŸ–¼ï¸ Starting mugshot embedding for all records...');var sheet=getOrCreateTargetSheet_();var lastRow=sheet.getLastRow();if(lastRow<2){Logger.log('â„¹ï¸ No records to process');return}embedMugshotsForRange_(sheet,2,lastRow);Logger.log('âœ… Mugshot embedding complete')}catch(e){Logger.log('âŒ Error: '+(e&&e.stack?e.stack:e))}finally{lock.releaseLock()}}

function embedMugshotsForRange_(sheet,startRow,endRow){if(startRow>endRow||startRow<2)return;var hdr=headers_();var mugshotIdx=hdr.indexOf('Mugshot_URL')+1;if(!mugshotIdx){Logger.log('âš ï¸ Mugshot_URL column not found');return}try{var numRows=endRow-startRow+1;var mugshotData=sheet.getRange(startRow,mugshotIdx,numRows,1).getValues();var embedded=0;for(var i=0;i<mugshotData.length;i++){var url=mugshotData[i][0];if(url&&String(url).trim()&&String(url).indexOf('http')===0){try{var currentRow=startRow+i;var cell=sheet.getRange(currentRow,mugshotIdx);var formula='=IMAGE("'+String(url).replace(/"/g,'\\"')+'", 4, 80, 80)';cell.setFormula(formula);embedded++}catch(imgErr){Logger.log('âš ï¸ Failed to embed mugshot at row '+(startRow+i)+': '+imgErr.message)}}}if(embedded>0){sheet.setRowHeights(startRow,numRows,85);Logger.log('ğŸ–¼ï¸ Embedded '+embedded+' mugshot(s)')}else{Logger.log('â„¹ï¸ No valid mugshot URLs found in range')}}catch(e){Logger.log('âš ï¸ Error embedding mugshots: '+e.message)}}

// ========== LEGACY SHIMS ==========
function scrapeArrestsFromAJAX(){Logger.log('â†ªï¸ scrapeArrestsFromAJAX â†’ runLeeArrestsNow');return runLeeArrestsNow()}
function scrapeRecentBookings(){Logger.log('â†ªï¸ scrapeRecentBookings â†’ runLeeArrestsNow');return runLeeArrestsNow()}

// ========== API ==========
function fetchArrestsFromApi_(startDate,endDate){var s=formatDate_(startDate),e=formatDate_(endDate),variants=[{startBooking:s,endBooking:e},{startBooking:s+'T00:00:00',endBooking:e+'T23:59:59'},{bookingStart:s,bookingEnd:e},{start:s,end:e}];for(var i=0;i<variants.length;i++){Logger.log('ğŸ”„ Trying API variant '+(i+1)+'/'+variants.length);var got=fetchWithPagination_(variants[i]);if(got&&got.length){Logger.log('âœ… Found '+got.length+' results with variant '+(i+1));return got}}Logger.log('âš ï¸ No results from any API variant');return[]}
function fetchWithPagination_(params){var all=[],offset=0;for(var page=0;page<LEE.MAX_PAGES;page++){var q=buildQueryString_(mergeObjects_(params,{limit:LEE.PAGE_SIZE,offset:offset})),url=LEE.ENDPOINTS.BASE+LEE.ENDPOINTS.PUBLIC_API+'?'+q;if(page===0)Logger.log('ğŸ“¡ API URL: '+url);else if(page%5===0)Logger.log('ğŸ“„ Page '+(page+1)+' (offset: '+offset+')');var resp=httpFetch_(url);if(!resp||resp.code!==200){Logger.log('âš ï¸ API returned status '+(resp?resp.code:'unknown'));break}var json=tryJson_(resp.text);if(!json){Logger.log('âš ï¸ Failed to parse JSON');break}var arr=extractRecords_(json);if(!arr||!arr.length){Logger.log('â„¹ï¸ No more records at page '+(page+1));break}for(var i=0;i<arr.length;i++){var norm=normalizeArrestRecord_(arr[i]);if(norm&&norm.bookingNumber)all.push(norm)}if(arr.length<LEE.PAGE_SIZE){Logger.log('â„¹ï¸ Last page (partial with '+arr.length+' records)');break}offset+=LEE.PAGE_SIZE}return all}
function extractRecords_(data){if(Array.isArray(data))return data;if(data&&Array.isArray(data.results))return data.results;if(data&&Array.isArray(data.data))return data.data;if(data&&Array.isArray(data.bookings))return data.bookings;if(data&&Array.isArray(data.records))return data.records;return[]}

// ========== CHARGES API ENRICHMENT ==========
function enrichWithChargesApi_(items){var out=[],ok=0,fail=0;for(var i=0;i<items.length;i++){var base=items[i];if(!base.bookingNumber){out.push(base);continue}if(i>0&&i%10===0)Logger.log('ğŸ”¬ Progress: '+i+'/'+items.length+' (success: '+ok+', fail: '+fail+')');Utilities.sleep(LEE.DETAIL_DELAY_MS);try{var chargesUrl=LEE.ENDPOINTS.BASE+LEE.ENDPOINTS.CHARGES_API.replace('{id}',base.bookingNumber);var resp=httpFetch_(chargesUrl);if(!resp||resp.code!==200){Logger.log('âš ï¸ Charges API failed for booking '+base.bookingNumber+': HTTP '+(resp?resp.code:'error'));out.push(base);fail++;continue}var json=tryJson_(resp.text);if(!json||!Array.isArray(json)){Logger.log('âš ï¸ Invalid charges JSON for booking '+base.bookingNumber);out.push(base);fail++;continue}var parsed=parseChargesFromApi_(json);Logger.log('ğŸ“Š Booking '+base.bookingNumber+': extracted '+parsed.charges.length+' charge(s), Bond Paid: '+parsed.bondPaid);out.push(mergeObjects_(base,{charges:parsed.charges,bondAmount:parsed.bondAmount||'',bondPaid:parsed.bondPaid||'',bondType:parsed.bondType||'',courtType:parsed.courtType||'',caseNumber:parsed.caseNumber||'',courtDate:parsed.courtDate||'',courtTime:parsed.courtTime||'',courtLocation:parsed.courtLocation||''}));ok++}catch(e){Logger.log('âš ï¸ Charges API error for booking '+base.bookingNumber+': '+e.message);out.push(base);fail++}}Logger.log('âœ… Enrichment complete: '+ok+' success, '+fail+' failed');return out}

// Parse charges data from the API JSON response
function parseChargesFromApi_(chargesArray){var out={charges:[],bondAmount:'',bondPaid:'',bondType:'',courtType:'',caseNumber:'',courtDate:'',courtTime:'',courtLocation:''};if(!Array.isArray(chargesArray)||!chargesArray.length)return out;var totalBond=0,bondTypes=new Set(),caseNumbers=new Set(),courtLocations=new Set(),courtDates=[],hasPaidBond=false;for(var i=0;i<chargesArray.length;i++){var c=chargesArray[i];if(c.offenseDescription){var charge=cleanChargeText_(String(c.offenseDescription).trim());if(charge&&charge.length>3&&!isStatuteOnly_(charge)){out.charges.push(charge)}}if(c.bondAmount){var amt=parseFloat(String(c.bondAmount).replace(/,/g,''));if(!isNaN(amt))totalBond+=amt}if(c.bondTypeName){var bt=String(c.bondTypeName).trim().toUpperCase();if(bt)bondTypes.add(bt)}if(c.bondDatePosted||c.bondPosted||c.dateBondPosted){hasPaidBond=true}if(c.caseNumber){var cn=String(c.caseNumber).trim();if(cn)caseNumbers.add(cn)}if(c.courtLocation){var cl=String(c.courtLocation).trim();if(cl)courtLocations.add(cl)}if(c.hearingDate){var hd=parseISODateTime_(c.hearingDate);if(hd.date)courtDates.push({date:hd.date,time:hd.time})}}out.charges=deduplicateAndLimit_(out.charges,15);out.bondAmount=totalBond>0?String(totalBond.toFixed(2)):'';out.bondType=Array.from(bondTypes).join(' / ');out.bondPaid=hasPaidBond?'YES':'NO';out.caseNumber=Array.from(caseNumbers).join(', ');out.courtLocation=Array.from(courtLocations).join(', ');if(courtDates.length>0){courtDates.sort(function(a,b){return a.date.localeCompare(b.date)});out.courtDate=courtDates[0].date;out.courtTime=courtDates[0].time}var firstLocation=Array.from(courtLocations)[0]||'';if(firstLocation.toLowerCase().indexOf('county')!==-1)out.courtType='County Court';else if(firstLocation.toLowerCase().indexOf('circuit')!==-1)out.courtType='Circuit Court';else if(firstLocation.toLowerCase().indexOf('federal')!==-1)out.courtType='Federal Court';return out}

// ========== SHEET I/O ==========
function headers_(){return['Scrape_Timestamp','County','Booking_Number','Person_ID','Full_Name','First_Name','Middle_Name','Last_Name','DOB','Booking_Date','Booking_Time','Status','Facility','Race','Sex','Height','Weight','Address','City','State','ZIP','Mugshot_URL','Charges','Bond_Amount','Bond_Paid','Bond_Type','Court_Type','Case_Number','Court_Date','Court_Time','Court_Location','Detail_URL']}
function getOrCreateTargetSheet_(){var ss=SpreadsheetApp.openById(LEE.SHEET_ID),sh=ss.getSheetByName(LEE.TAB_NAME);if(!sh){Logger.log('âŒ '+LEE.TAB_NAME+' sheet not found!');throw new Error(LEE.TAB_NAME+' sheet not found!')}var hdr=headers_();if(sh.getLastRow()===0){sh.getRange(1,1,1,hdr.length).setValues([hdr]);sh.setFrozenRows(1);return sh}sh.getRange(1,1,1,hdr.length).setValues([hdr]);sh.setFrozenRows(1);return sh}
function loadExistingBookingNumbers_(sheet){var set=new Set(),last=sheet.getLastRow();if(last<2)return set;var bookingNumberIdx=headers_().indexOf('Booking_Number')+1;var vals=sheet.getRange(2,bookingNumberIdx,last-1,1).getValues();for(var i=0;i<vals.length;i++){var v=vals[i][0];if(v!=null&&v!=='')set.add(String(v).trim())}return set}
function upsertStrict_(sheet,records){if(!records||!records.length)return;var hdr=headers_(),width=hdr.length,last=sheet.getLastRow(),existing=new Map();var bookingNumberIdx=hdr.indexOf('Booking_Number')+1;if(last>=2){var keys=sheet.getRange(2,bookingNumberIdx,last-1,1).getValues();for(var i=0;i<keys.length;i++){var k=keys[i][0];if(k!=null&&k!=='')existing.set(String(k).trim(),i+2)}}var updates=[],appends=[];for(var r=0;r<records.length;r++){var row=recordToRow_(records[r]),key=row[bookingNumberIdx-1];if(existing.has(key))updates.push({row:existing.get(key),values:row});else appends.push(row)}if(updates.length)updates.forEach(function(u){sheet.getRange(u.row,1,1,width).setValues([u.values])});if(appends.length)sheet.getRange(sheet.getLastRow()+1,1,appends.length,width).setValues(appends)}
function recordToRow_(r){var chargesStr=Array.isArray(r.charges)?r.charges.join(' | '):(r.charges||'');return[new Date(),LEE.COUNTY_NAME,limitString_(r.bookingNumber,100),limitString_(r.personId,100),limitString_(r.fullName,200),limitString_(r.firstName,100),limitString_(r.middleName,100),limitString_(r.lastName,100),limitString_(r.dob,50),limitString_(r.bookingDate,50),limitString_(r.bookingTime,50),limitString_(r.currentStatus,50),limitString_(r.currentFacility,150),limitString_(r.race,50),limitString_(r.sex,20),limitString_(r.height,50),limitString_(r.weight,50),limitString_(r.address,300),limitString_(r.city,100),limitString_(r.state,20),limitString_(r.zip,20),limitString_(r.mugshotUrl,500),limitString_(chargesStr,8000),limitString_(r.bondAmount,50),limitString_(r.bondPaid,20),limitString_(r.bondType,50),limitString_(r.courtType,100),limitString_(r.caseNumber,100),limitString_(r.courtDate,50),limitString_(r.courtTime,50),limitString_(r.courtLocation,300),limitString_(r.detailUrl,500)]}

// ========== NORMALIZER ==========
function normalizeArrestRecord_(raw){if(!raw)return null;var first=safeString_(raw.givenName||raw.first_name||raw.firstName||raw.fname),last=safeString_(raw.surName||raw.surnames||raw.last_name||raw.lastName||raw.lname),middle=safeString_(raw.middleName||raw.middle_name||raw.mname),suffix=safeString_(raw.suffix||raw.nameSuffix||'');var bookingNumber=safeString_(raw.bookingNumber||raw.booking_number||raw.booking_id||raw.bookingNo||raw.id);if(!bookingNumber)return null;var full=buildFullName_(first,middle,last,suffix),bookingISO=safeString_(raw.bookingDate||raw.booked_date||raw.arrestDate),dobISO=safeString_(raw.birthDate||raw.birthdate||raw.dob||raw.dateOfBirth),bp=parseISODateTime_(bookingISO),dp=parseISODateTime_(dobISO);var address=safeString_(raw.address||raw.address1||raw.street),city=safeString_(raw.city),state=safeString_(raw.state||'FL'),zip=safeString_(raw.zip||raw.zipcode||raw.postalCode);if(address&&(!city||!zip)){var a=splitAddressString_(address);address=a.street||address;city=city||a.city;state=state||a.state;zip=zip||a.zip}var status='In Custody';if(raw.inCustody===false||raw.in_custody===false||raw.releaseDate||raw.release_date)status='Released';if(raw.currentStatus||raw.status)status=safeString_(raw.currentStatus||raw.status);return{bookingNumber:bookingNumber,personId:safeString_(raw.permId||raw.person_id||raw.personId||raw.inmateId),fullName:full,firstName:first,middleName:middle,lastName:last,dob:dp.date,bookingDate:bp.date,bookingTime:bp.time,currentStatus:status,currentFacility:safeString_(raw.housing||raw.facility||raw.location||'Lee County Jail'),race:safeString_(raw.race),sex:safeString_(raw.sex||raw.gender),height:safeString_(raw.height),weight:safeString_(raw.weight),address:address,city:city,state:state,zip:zip,charges:Array.isArray(raw.charges)?raw.charges:[],mugshotUrl:raw.image?makeAbsoluteURL_(raw.image):raw.photo?makeAbsoluteURL_(raw.photo):'',bondAmount:'',bondPaid:'',bondType:'',courtType:'',caseNumber:'',courtDate:'',courtTime:'',courtLocation:'',detailUrl:buildDetailURL_(bookingNumber)}}

// ========== HTTP & UTILITIES ==========
function httpFetch_(url){for(var attempt=0;attempt<LEE.RETRY_LIMIT;attempt++){try{var res=UrlFetchApp.fetch(url,{method:'get',muteHttpExceptions:true,followRedirects:true,headers:{'User-Agent':'Mozilla/5.0 (AppsScript)','Accept':'application/json, text/html, */*','Accept-Language':'en-US,en;q=0.9'}});var code=res.getResponseCode();if(code===200)return{code:code,text:res.getContentText()};if(code===429||code>=500){var sleep=LEE.BACKOFF_BASE_MS*Math.pow(2,attempt);Logger.log('â³ HTTP '+code+' retry in '+sleep+'ms');Utilities.sleep(sleep);continue}return{code:code,text:res.getContentText()}}catch(e){var back=LEE.BACKOFF_BASE_MS*Math.pow(2,attempt);if(attempt<LEE.RETRY_LIMIT-1){Logger.log('âš ï¸ HTTP error, retrying in '+back+'ms: '+e);Utilities.sleep(back)}else{Logger.log('âŒ HTTP failed after retries: '+url);return null}}}return null}
function tryJson_(s){try{return JSON.parse(s)}catch(e){return null}}
function safeString_(v){return(v==null||v===undefined)?'':String(v).trim()}
function match1_(s,re){var m=(s||'').match(re);return m?(m[1]||''):''}
function buildQueryString_(params){var parts=[];for(var k in params)parts.push(encodeURIComponent(k)+'='+encodeURIComponent(params[k]));return parts.join('&')}
function mergeObjects_(a,b){var o={};for(var k in a)o[k]=a[k];for(var j in b)o[j]=b[j];return o}
function makeAbsoluteURL_(url){if(!url)return'';if(url.indexOf('http')===0)return url;var base=(LEE.ENDPOINTS&&LEE.ENDPOINTS.BASE)||'https://www.sheriffleefl.org';return base+(url.charAt(0)==='/'?url:'/'+url)}
function buildDetailURL_(bookingNumber){if(!bookingNumber)return'';var base=(LEE.ENDPOINTS&&LEE.ENDPOINTS.BASE)||'https://www.sheriffleefl.org',path=(LEE.ENDPOINTS&&LEE.ENDPOINTS.DETAIL_PAGE)||'/booking/';return base+path+'?id='+encodeURIComponent(bookingNumber)}
function formatDate_(date){return Utilities.formatDate(date,LEE.TIMEZONE,'yyyy-MM-dd')}
function parseISODateTime_(iso){if(!iso)return{date:'',time:''};try{var d=new Date(iso);return{date:Utilities.formatDate(d,LEE.TIMEZONE,'yyyy-MM-dd'),time:Utilities.formatDate(d,LEE.TIMEZONE,'HH:mm:ss')}}catch(e){return{date:String(iso),time:''}}}
function buildFullName_(first,middle,last,suffix){if(!first&&!last)return'';if(!last)return first+(suffix?' '+suffix:'');if(!first)return last+(suffix?' '+suffix:'');var name=last+', '+first;if(middle)name+=' '+middle;if(suffix)name+=' '+suffix;return name}
function splitAddressString_(s){if(!s)return{street:'',city:'',state:'',zip:''};s=String(s).trim().replace(/\s{2,}/g,' ');var m=s.match(/^(.+?),\s*([^,]+?),\s*([A-Z]{2})\s+(\d{5}(?:-\d{4})?)$/i);if(m)return{street:m[1].trim(),city:m[2].trim(),state:m[3].toUpperCase(),zip:m[4]};m=s.match(/^(.+?)\s+([A-Z][A-Za-z\s]+?)\s+([A-Z]{2})\s+(\d{5}(?:-\d{4})?)$/);if(m){var streetTypes=['ST','STREET','AVE','AVENUE','RD','ROAD','DR','DRIVE','LN','LANE','WAY','BLVD','BOULEVARD','CT','COURT','CIR','CIRCLE','TER','TERRACE','PKWY','PARKWAY','HWY','HIGHWAY','PL','PLACE','TRL','TRAIL','LOOP'];var streetParts=m[1].split(' ');for(var i=streetParts.length-1;i>=0;i--){var word=streetParts[i].toUpperCase().replace(/\./g,'');if(streetTypes.indexOf(word)>-1){var actualStreet=streetParts.slice(0,i+1).join(' ');var actualCity=streetParts.slice(i+1).join(' ')+' '+m[2];return{street:actualStreet,city:actualCity.trim(),state:m[3].toUpperCase(),zip:m[4]}}}return{street:m[1].trim(),city:m[2].trim(),state:m[3].toUpperCase(),zip:m[4]}}m=s.match(/^(.+?)\s+(\d{5}(?:-\d{4})?)$/);if(m)return{street:m[1].trim(),city:'',state:'FL',zip:m[2]};return{street:s,city:'',state:'',zip:''}}

// ========== CHARGE TEXT HELPERS ==========
function cleanChargeText_(text){if(!text)return'';text=String(text).replace(/\s+/g,' ').trim();text=text.replace(/\s+\b(?:F|M)\d+\s*$/i,'');text=text.replace(/\s+\bFS\s*\d[\d\.\-]*\s*$/i,'');text=text.replace(/\s+\bFSS\s*\d[\d\.\-]*\s*$/i,'');text=text.replace(/\s+\bF\.?S\.?\s*\d[\d\.\-]*\s*$/i,'');text=text.replace(/\s+\(\d[\d\.\-]+\)\s*$/i,'');text=text.replace(/\s+\b\d{3,}\.\d+\s*$/i,'');text=text.replace(/\s*\([FfMm]\d+\)\s*$/i,'');return text.trim()}
function isStatuteOnly_(text){if(!text)return true;var t=text.trim();return /^(?:F|M)\d+$/i.test(t)||/^FS\s*\d[\d\.\-]*$/i.test(t)||/^FSS\s*\d[\d\.\-]*$/i.test(t)||/^F\.?S\.?\s*\d[\d\.\-]*$/i.test(t)||/^\d[\d\.\-]+$/i.test(t)||/^N\/A$/i.test(t)||t.length<4}
function deduplicateAndLimit_(arr,max){if(!Array.isArray(arr))return[];var seen=new Set(),out=[];for(var i=0;i<arr.length&&out.length<(max||15);i++){var v=String(arr[i]).trim();if(v&&!seen.has(v.toLowerCase())){seen.add(v.toLowerCase());out.push(v)}}return out}
function limitString_(v,n){var s=(v==null?'':String(v)),maxLen=n||LEE.MAX_CELL_LEN;maxLen=(n&&n<LEE.MAX_CELL_LEN)?n:LEE.MAX_CELL_LEN;return s.length>maxLen?s.slice(0,maxLen-3)+'...':s}
