<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Shamrock Bail Bonds - Enterprise Control Center</title>
  
  <!-- PDF-LIB for in-browser PDF manipulation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
  
  <!-- Google Places API for Address Autocomplete -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAB7IgKfDSbkrbmHrhqrCshPhAl-Ev0K4U&libraries=places"></script>
  
  <!-- Google Fonts for Enterprise Look -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* =========================================================
       ENTERPRISE THEME SYSTEM - Fortune 50 Grade
       ========================================================= */
    :root {
      --radius: 16px;
      --radius-sm: 10px;
      --radius-lg: 24px;
      --shadow: 0 20px 60px rgba(0,0,0,.15), 0 8px 25px rgba(0,0,0,.1);
      --shadow-soft: 0 8px 30px rgba(0,0,0,.08);
      --shadow-glow: 0 0 40px rgba(212,175,55,.15);
      --transition: all .3s cubic-bezier(.4,0,.2,1);

      /* Defaults - Refined Palette */
      --bg: #f8f9fc;
      --surface: #ffffff;
      --surface-2: #f1f3f9;
      --surface-3: #e8ecf4;
      --text: #0f172a;
      --text-secondary: #475569;
      --muted: #64748b;
      --border: rgba(15,23,42,.08);
      --border-strong: rgba(15,23,42,.15);

      --brand: #0f172a;
      --brand-2: #1e293b;
      --accent: #d4af37;
      --accent-2: #f5d76e;
      --accent-rgb: 212,175,55;

      --success: #10b981;
      --success-bg: rgba(16,185,129,.1);
      --error: #ef4444;
      --error-bg: rgba(239,68,68,.1);
      --warning: #f59e0b;
      --warning-bg: rgba(245,158,11,.1);
      --info: #3b82f6;
      --info-bg: rgba(59,130,246,.1);

      --focus: 0 0 0 4px rgba(212,175,55,.2);
      --gradient-brand: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      --gradient-accent: linear-gradient(135deg, #d4af37 0%, #f5d76e 100%);
      --gradient-glass: linear-gradient(135deg, rgba(255,255,255,.9) 0%, rgba(255,255,255,.7) 100%);
    }

    /* Light Mode */
    body[data-mode="light"] {
      --bg: #f8f9fc;
      --surface: #ffffff;
      --surface-2: #f1f3f9;
      --surface-3: #e8ecf4;
      --text: #0f172a;
      --text-secondary: #475569;
      --muted: #64748b;
      --border: rgba(15,23,42,.08);
      --border-strong: rgba(15,23,42,.15);
    }

    /* Dark Mode - Premium */
    body[data-mode="dark"] {
      --bg: #0a0e17;
      --surface: #111827;
      --surface-2: #1e293b;
      --surface-3: #334155;
      --text: #f8fafc;
      --text-secondary: #cbd5e1;
      --muted: #94a3b8;
      --border: rgba(255,255,255,.08);
      --border-strong: rgba(255,255,255,.15);
      --shadow: 0 20px 60px rgba(0,0,0,.5), 0 8px 25px rgba(0,0,0,.3);
      --shadow-soft: 0 8px 30px rgba(0,0,0,.25);
      --gradient-glass: linear-gradient(135deg, rgba(30,41,59,.9) 0%, rgba(30,41,59,.7) 100%);
    }

    /* THEME: TUXEDO (Black/Gold) */
    body[data-theme="tuxedo"] {
      --brand: #0a0e14;
      --brand-2: #111827;
      --accent: #d4af37;
      --accent-2: #f5d76e;
      --accent-rgb: 212,175,55;
    }

    /* THEME: EMERALD */
    body[data-theme="emerald"] {
      --brand: #064e3b;
      --brand-2: #065f46;
      --accent: #10b981;
      --accent-2: #34d399;
      --accent-rgb: 16,185,129;
    }

    /* THEME: SAPPHIRE */
    body[data-theme="sapphire"] {
      --brand: #1e3a5f;
      --brand-2: #1e40af;
      --accent: #3b82f6;
      --accent-2: #60a5fa;
      --accent-rgb: 59,130,246;
    }

    /* THEME: FLAMINGO */
    body[data-theme="flamingo"] {
      --brand: #1a0a1a;
      --brand-2: #2d1a2d;
      --accent: #ec4899;
      --accent-2: #f472b6;
      --accent-rgb: 236,72,153;
    }

    /* THEME: MIDNIGHT GOLD */
    body[data-theme="midnight-gold"] {
      --brand: #0c1222;
      --brand-2: #162032;
      --accent: #fbbf24;
      --accent-2: #fcd34d;
      --accent-rgb: 251,191,36;
    }

    /* THEME: OBSIDIAN */
    body[data-theme="obsidian"] {
      --brand: #09090b;
      --brand-2: #18181b;
      --accent: #a1a1aa;
      --accent-2: #d4d4d8;
      --accent-rgb: 161,161,170;
    }

    /* =========================================================
       GLOBAL STYLES - Enterprise Grade
       ========================================================= */
    * { box-sizing: border-box; margin: 0; padding: 0; }

    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      transition: var(--transition);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 32px;
    }

    /* =========================================================
       ENTERPRISE HEADER
       ========================================================= */
    .header {
      background: var(--gradient-brand);
      color: #fff;
      padding: 28px 40px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      margin-bottom: 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 20px;
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 400px;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(var(--accent-rgb),.1));
      pointer-events: none;
    }

    .header-brand {
      display: flex;
      align-items: center;
      gap: 16px;
      z-index: 1;
    }

    .header-logo {
      width: 56px;
      height: 56px;
      background: var(--gradient-accent);
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      box-shadow: 0 4px 15px rgba(var(--accent-rgb),.3);
    }

    .header-title {
      font-size: 26px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .header-subtitle {
      font-size: 13px;
      opacity: 0.75;
      font-weight: 400;
      margin-top: 2px;
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
      z-index: 1;
    }

    .header-stat {
      background: rgba(255,255,255,.1);
      backdrop-filter: blur(10px);
      padding: 10px 18px;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(255,255,255,.15);
    }

    .header-stat-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      opacity: 0.7;
    }

    .header-stat-value {
      font-size: 18px;
      font-weight: 700;
      font-family: 'SF Mono', 'Consolas', monospace;
      color: var(--accent);
    }

    .theme-selector select,
    .mode-toggle {
      padding: 10px 16px;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(255,255,255,.2);
      background: rgba(255,255,255,.1);
      backdrop-filter: blur(10px);
      color: #fff;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
    }

    .theme-selector select:hover,
    .mode-toggle:hover {
      background: rgba(255,255,255,.2);
      border-color: rgba(255,255,255,.3);
    }

    /* =========================================================
       NAVIGATION TABS - Enterprise Style
       ========================================================= */
    .nav-container {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 8px;
      margin-bottom: 32px;
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      border: 1px solid var(--border);
    }

    .tab {
      padding: 14px 24px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
    }

    .tab:hover {
      background: var(--surface-2);
      color: var(--text);
    }

    .tab.active {
      background: var(--accent);
      color: #000;
      box-shadow: 0 4px 15px rgba(var(--accent-rgb),.3);
    }

    .tab-icon {
      font-size: 18px;
    }

    .tab-badge {
      background: var(--error);
      color: #fff;
      font-size: 10px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 10px;
      min-width: 18px;
      text-align: center;
    }

    .tab.active .tab-badge {
      background: rgba(0,0,0,.3);
    }

    .tab-content {
      display: none;
      animation: fadeIn .3s ease;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* =========================================================
       CARDS - Glass Morphism Style
       ========================================================= */
    .card {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 28px;
      box-shadow: var(--shadow-soft);
      margin-bottom: 24px;
      border: 1px solid var(--border);
      transition: var(--transition);
    }

    .card:hover {
      box-shadow: var(--shadow);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
      gap: 16px;
    }

    .card-header h3 {
      font-size: 20px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--text);
    }

    .card-header h3 .icon {
      width: 40px;
      height: 40px;
      background: var(--surface-2);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    /* =========================================================
       FORM ELEMENTS - Premium Style
       ========================================================= */
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .form-group label.required::after {
      content: "*";
      color: var(--error);
      font-weight: 700;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 14px 16px;
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--surface-2);
      color: var(--text);
      font-size: 15px;
      font-weight: 500;
      transition: var(--transition);
      font-family: inherit;
    }

    .form-group input:hover,
    .form-group select:hover,
    .form-group textarea:hover {
      border-color: var(--border-strong);
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: var(--focus);
      background: var(--surface);
    }

    .form-group input::placeholder {
      color: var(--muted);
      font-weight: 400;
    }

    /* =========================================================
       BUTTONS - Enterprise Grade
       ========================================================= */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      text-decoration: none;
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.2), transparent);
      transition: left .5s;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn-primary {
      background: var(--gradient-accent);
      color: #000;
      box-shadow: 0 4px 15px rgba(var(--accent-rgb),.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(var(--accent-rgb),.4);
    }

    .btn-secondary {
      background: var(--surface-2);
      color: var(--text);
      border: 2px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--surface-3);
      border-color: var(--border-strong);
    }

    .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: #fff;
      box-shadow: 0 4px 15px rgba(16,185,129,.3);
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(16,185,129,.4);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: #fff;
    }

    .btn-lg {
      padding: 18px 36px;
      font-size: 16px;
      border-radius: var(--radius);
    }

    .btn-sm {
      padding: 8px 16px;
      font-size: 13px;
    }

    .btn-icon {
      width: 44px;
      height: 44px;
      padding: 0;
      border-radius: 12px;
    }

    /* =========================================================
       COUNTY SCRAPER GRID - Enterprise Dashboard
       ========================================================= */
    .county-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
    }

    .county-card {
      background: var(--surface-2);
      border: 2px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .county-card:hover {
      border-color: var(--accent);
      transform: translateY(-4px);
      box-shadow: var(--shadow);
    }

    .county-card.active {
      border-color: var(--success);
      background: var(--success-bg);
    }

    .county-card.pending {
      border-color: var(--warning);
    }

    .county-card.coming-soon {
      opacity: 0.6;
    }

    .county-card .status-dot {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--muted);
    }

    .county-card.active .status-dot {
      background: var(--success);
      box-shadow: 0 0 10px var(--success);
      animation: pulse 2s infinite;
    }

    .county-card.pending .status-dot {
      background: var(--warning);
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .county-card .county-icon {
      font-size: 32px;
      margin-bottom: 12px;
    }

    .county-card .county-name {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .county-card .county-status {
      font-size: 12px;
      color: var(--muted);
      font-weight: 500;
    }

    .county-card .county-count {
      position: absolute;
      bottom: 16px;
      right: 16px;
      background: var(--accent);
      color: #000;
      font-size: 11px;
      font-weight: 700;
      padding: 4px 10px;
      border-radius: 20px;
    }

    .county-card .county-stats {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
      font-size: 12px;
      color: var(--text-secondary);
    }

    .county-card .county-stats .stat-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .county-card .county-stats .stat-label {
      color: var(--muted);
    }

    .county-card .county-stats .stat-value {
      font-weight: 600;
      color: var(--text);
    }

    .county-card .county-stats .stat-value.male {
      color: var(--info);
    }

    .county-card .county-stats .stat-value.female {
      color: var(--accent);
    }

    .county-card .county-stats .crime-breakdown {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .county-card .county-stats .crime-tag {
      background: var(--surface-3);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: 500;
    }

    .county-card .open-blotter-btn {
      margin-top: 12px;
      width: 100%;
      padding: 8px 12px;
      background: var(--accent);
      color: #000;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }

    .county-card .open-blotter-btn:hover {
      background: var(--accent-2);
      transform: scale(1.02);
    }

    /* =========================================================
       DOCUMENT CHECKLIST - Premium Style
       ========================================================= */
    .doc-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 12px;
    }

    .doc-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 16px 20px;
      background: var(--surface-2);
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: var(--transition);
    }

    .doc-item:hover {
      background: var(--surface);
      border-color: var(--border-strong);
    }

    .doc-item.checked {
      border-color: var(--accent);
      background: rgba(var(--accent-rgb),.05);
    }

    .doc-item input[type="checkbox"] {
      width: 22px;
      height: 22px;
      accent-color: var(--accent);
      cursor: pointer;
    }

    .doc-item .doc-info {
      flex: 1;
    }

    .doc-item .doc-name {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 2px;
    }

    .doc-item .doc-meta {
      font-size: 12px;
      color: var(--muted);
    }

    .doc-item .doc-badge {
      background: var(--surface-3);
      color: var(--text-secondary);
      font-size: 11px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 20px;
    }

    /* =========================================================
       CHARGE & INDEMNITOR CARDS
       ========================================================= */
    .entity-card {
      background: var(--surface-2);
      border: 2px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      margin-bottom: 16px;
      position: relative;
      transition: var(--transition);
    }

    .entity-card:hover {
      border-color: var(--border-strong);
    }

    .entity-card.charge {
      border-left: 4px solid var(--accent);
    }

    .entity-card.indemnitor {
      border-left: 4px solid var(--success);
    }

    .entity-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .entity-header h4 {
      font-size: 16px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .entity-header .entity-number {
      background: var(--accent);
      color: #000;
      width: 28px;
      height: 28px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
    }

    .btn-remove {
      background: var(--error-bg);
      color: var(--error);
      border: none;
      border-radius: 8px;
      width: 36px;
      height: 36px;
      cursor: pointer;
      font-size: 18px;
      transition: var(--transition);
    }

    .btn-remove:hover {
      background: var(--error);
      color: #fff;
    }

    /* =========================================================
       SUMMARY PANEL
       ========================================================= */
    .summary-panel {
      background: var(--gradient-brand);
      color: #fff;
      border-radius: var(--radius);
      padding: 24px;
      margin-bottom: 24px;
      position: relative;
      overflow: hidden;
    }

    .summary-panel::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 300px;
      height: 300px;
      background: radial-gradient(circle, rgba(var(--accent-rgb),.2) 0%, transparent 70%);
      pointer-events: none;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 20px;
      position: relative;
      z-index: 1;
    }

    .summary-item {
      background: rgba(255,255,255,.1);
      backdrop-filter: blur(10px);
      padding: 16px 20px;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(255,255,255,.1);
    }

    .summary-item .label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      opacity: 0.7;
      margin-bottom: 6px;
    }

    .summary-item .value {
      font-size: 20px;
      font-weight: 700;
    }

    .summary-item .value.accent {
      color: var(--accent);
    }

    /* =========================================================
       PROGRESS OVERLAY
       ========================================================= */
    .progress-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,.8);
      backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .progress-overlay.active {
      display: flex;
    }

    .progress-card {
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: 48px;
      max-width: 500px;
      width: 90%;
      text-align: center;
      box-shadow: var(--shadow);
    }

    .progress-card h3 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 24px;
    }

    .progress-bar {
      height: 8px;
      background: var(--surface-2);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 16px;
    }

    .progress-fill {
      height: 100%;
      background: var(--gradient-accent);
      border-radius: 4px;
      width: 0%;
      transition: width .3s ease;
    }

    .progress-message {
      color: var(--muted);
      font-size: 14px;
    }

    .progress-steps {
      margin-top: 24px;
      text-align: left;
    }

    .progress-step {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 0;
      color: var(--muted);
      font-size: 14px;
    }

    .progress-step.active {
      color: var(--text);
      font-weight: 600;
    }

    .progress-step.complete {
      color: var(--success);
    }

    .progress-step .step-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--surface-2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }

    .progress-step.active .step-icon {
      background: var(--accent);
      color: #000;
    }

    .progress-step.complete .step-icon {
      background: var(--success);
      color: #fff;
    }

    /* =========================================================
       NOTIFICATION TOAST
       ========================================================= */
    .toast-container {
      position: fixed;
      top: 24px;
      right: 24px;
      z-index: 10001;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .toast {
      background: var(--surface);
      border-radius: var(--radius-sm);
      padding: 16px 24px;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 300px;
      animation: slideIn .3s ease;
      border-left: 4px solid var(--accent);
    }

    .toast.success { border-left-color: var(--success); }
    .toast.error { border-left-color: var(--error); }
    .toast.warning { border-left-color: var(--warning); }
    .toast.info { border-left-color: var(--info); }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .toast-icon {
      font-size: 20px;
    }

    .toast-message {
      flex: 1;
      font-weight: 500;
    }

    .toast-close {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-size: 18px;
      padding: 4px;
    }

    /* =========================================================
       QUICK ACTIONS FAB
       ========================================================= */
    .fab-container {
      position: fixed;
      bottom: 32px;
      right: 32px;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 12px;
      z-index: 1000;
    }

    .fab {
      width: 60px;
      height: 60px;
      border-radius: 16px;
      border: none;
      background: var(--gradient-accent);
      color: #000;
      font-size: 24px;
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .fab:hover {
      transform: scale(1.1) rotate(5deg);
    }

    .fab.secondary {
      width: 50px;
      height: 50px;
      background: var(--surface);
      color: var(--text);
      border: 2px solid var(--border);
      font-size: 20px;
    }

    .fab.danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: #fff;
    }

    .fab.success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: #fff;
    }

    /* =========================================================
       RESPONSIVE
       ========================================================= */
    @media (max-width: 1024px) {
      .container { padding: 20px; }
      .header { padding: 20px 24px; }
      .card { padding: 20px; }
    }

    @media (max-width: 768px) {
      .header { flex-direction: column; text-align: center; }
      .header-controls { justify-content: center; }
      .nav-container { justify-content: center; }
      .tab { padding: 12px 16px; font-size: 13px; }
      .fab-container { bottom: 20px; right: 20px; }
    }

    /* =========================================================
       PRINT STYLES
       ========================================================= */
    @media print {
      .header, .nav-container, .fab-container, .toast-container { display: none !important; }
      .card { box-shadow: none; border: 1px solid #ddd; }
      body { background: #fff; }
    }
  </style>
</head>

<body data-theme="tuxedo" data-mode="dark">
  
  <!-- TOAST CONTAINER -->
  <div class="toast-container" id="toast-container"></div>

  <!-- PROGRESS OVERLAY -->
  <div class="progress-overlay" id="progress-overlay">
    <div class="progress-card">
      <h3 id="progress-title">Generating Bail Packet</h3>
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
      <p class="progress-message" id="progress-message">Initializing...</p>
      <div class="progress-steps" id="progress-steps"></div>
    </div>
  </div>

  <div class="container">
    
    <!-- ENTERPRISE HEADER -->
    <header class="header">
      <div class="header-brand">
        <div class="header-logo">&#9752;</div>
        <div>
          <h1 class="header-title">Shamrock Bail Bonds</h1>
          <p class="header-subtitle">Enterprise Control Center v3.0</p>
        </div>
      </div>
      
      <div class="header-controls">
        <div class="header-stat">
          <div class="header-stat-label">Receipt #</div>
          <div class="header-stat-value" id="receipt-display">201204</div>
        </div>
        
        <div class="theme-selector">
          <select id="theme-select" onchange="applyTheme(this.value)">
            <option value="tuxedo">Tuxedo Gold</option>
            <option value="emerald">Emerald</option>
            <option value="sapphire">Sapphire</option>
            <option value="flamingo">Flamingo</option>
            <option value="midnight-gold">Midnight Gold</option>
            <option value="obsidian">Obsidian</option>
          </select>
        </div>
        
        <button class="mode-toggle" onclick="toggleMode()">
          <span id="mode-icon">Light</span> <span id="mode-text">Light</span>
        </button>
      </div>
    </header>

    <!-- NAVIGATION TABS -->
    <nav class="nav-container">
      <button class="tab active" onclick="switchTab(this, 'scrapers')">
        <span class="tab-icon">&#128269;</span> Counties
      </button>
      <button class="tab" onclick="switchTab(this, 'charges')">
        <span class="tab-icon">&#9878;</span> Charges
        <span class="tab-badge" id="charges-badge" style="display:none;">0</span>
      </button>
      <button class="tab" onclick="switchTab(this, 'defendant')">
        <span class="tab-icon">&#128100;</span> Defendant
      </button>
      <button class="tab" onclick="switchTab(this, 'indemnitors')">
        <span class="tab-icon">&#129309;</span> Indemnitors
        <span class="tab-badge" id="indemnitors-badge" style="display:none;">0</span>
      </button>
      <button class="tab" onclick="switchTab(this, 'payment')">
        <span class="tab-icon">$</span> Payment
      </button>
      <button class="tab" onclick="switchTab(this, 'documents')">
        <span class="tab-icon">&#128196;</span> Documents
      </button>
      <button class="tab" onclick="switchTab(this, 'generate')">
        <span class="tab-icon">&#9654;</span> Generate & Send
      </button>
      <button class="tab" onclick="switchTab(this, 'status')">
        <span class="tab-icon">&#128202;</span> Status
      </button>
    </nav>

    <!-- ============================================================
         TAB: COUNTY SCRAPERS
         ============================================================ -->
    <div id="scrapers-tab" class="tab-content active">
      <div class="card">
        <div class="card-header">
          <h3><span class="icon">&#127963;</span> Florida County Booking Blotters</h3>
          <button class="btn btn-secondary btn-sm" onclick="refreshAllCountyStatus()">
            &#128260; Refresh Status
          </button>
        </div>
        
        <p style="margin-bottom: 24px; color: var(--text-secondary); font-size: 15px;">
          Click a county to open their booking blotter. Use your bookmarklet to scrape defendant data and auto-fill the form.
        </p>
        
        <div class="county-grid">
          <!-- PRIMARY COUNTIES (Active) -->
          <div class="county-card active" id="county-card-lee">
            <div class="status-dot"></div>
            <div class="county-icon">LEE</div>
            <div class="county-name">Lee County</div>
            <div class="county-status">Active - Primary</div>
            <div class="county-stats" id="lee-stats">
              <div class="stat-row">
                <span class="stat-label">Today's Arrests:</span>
                <span class="stat-value" id="lee-total">--</span>
              </div>
              <div class="stat-row">
                <span class="stat-label">Male / Female:</span>
                <span><span class="stat-value male" id="lee-male">--</span> / <span class="stat-value female" id="lee-female">--</span></span>
              </div>
              <div class="stat-row">
                <span class="stat-label">Avg Bond:</span>
                <span class="stat-value" id="lee-avg-bond">--</span>
              </div>
              <div class="crime-breakdown" id="lee-crimes"></div>
            </div>
            <button class="open-blotter-btn" onclick="openCountyScraper('lee')">&#128269; Open Booking Blotter</button>
          </div>
          
          <div class="county-card active" id="county-card-collier">
            <div class="status-dot"></div>
            <div class="county-icon">COL</div>
            <div class="county-name">Collier County</div>
            <div class="county-status">Active</div>
            <div class="county-stats" id="collier-stats">
              <div class="stat-row">
                <span class="stat-label">Today's Arrests:</span>
                <span class="stat-value" id="collier-total">--</span>
              </div>
              <div class="stat-row">
                <span class="stat-label">Male / Female:</span>
                <span><span class="stat-value male" id="collier-male">--</span> / <span class="stat-value female" id="collier-female">--</span></span>
              </div>
              <div class="stat-row">
                <span class="stat-label">Avg Bond:</span>
                <span class="stat-value" id="collier-avg-bond">--</span>
              </div>
              <div class="crime-breakdown" id="collier-crimes"></div>
            </div>
            <button class="open-blotter-btn" onclick="openCountyScraper('collier')">&#128269; Open Booking Blotter</button>
          </div>
          
          <div class="county-card active" id="county-card-charlotte">
            <div class="status-dot"></div>
            <div class="county-icon">CHA</div>
            <div class="county-name">Charlotte County</div>
            <div class="county-status">Active</div>
            <div class="county-stats" id="charlotte-stats">
              <div class="stat-row">
                <span class="stat-label">Today's Arrests:</span>
                <span class="stat-value" id="charlotte-total">--</span>
              </div>
              <div class="stat-row">
                <span class="stat-label">Male / Female:</span>
                <span><span class="stat-value male" id="charlotte-male">--</span> / <span class="stat-value female" id="charlotte-female">--</span></span>
              </div>
              <div class="stat-row">
                <span class="stat-label">Avg Bond:</span>
                <span class="stat-value" id="charlotte-avg-bond">--</span>
              </div>
              <div class="crime-breakdown" id="charlotte-crimes"></div>
            </div>
            <button class="open-blotter-btn" onclick="openCountyScraper('charlotte')">&#128269; Open Booking Blotter</button>
          </div>
          
          <div class="county-card pending" onclick="openCountyScraper('sarasota')">
            <div class="status-dot"></div>
            <div class="county-icon">SAR</div>
            <div class="county-name">Sarasota County</div>
            <div class="county-status">Scraper Pending</div>
          </div>
          
          <div class="county-card pending" onclick="openCountyScraper('hendry')">
            <div class="status-dot"></div>
            <div class="county-icon">HEN</div>
            <div class="county-name">Hendry County</div>
            <div class="county-status">Scraper Pending</div>
          </div>
          
          <div class="county-card pending" onclick="openCountyScraper('desoto')">
            <div class="status-dot"></div>
            <div class="county-icon">DES</div>
            <div class="county-name">DeSoto County</div>
            <div class="county-status">Low Traffic</div>
          </div>
          
          <div class="county-card pending" onclick="openCountyScraper('manatee')">
            <div class="status-dot"></div>
            <div class="county-icon">MAN</div>
            <div class="county-name">Manatee County</div>
            <div class="county-status">Scraper Pending</div>
          </div>
          
          <div class="county-card pending" onclick="openCountyScraper('palm-beach')">
            <div class="status-dot"></div>
            <div class="county-icon">PBC</div>
            <div class="county-name">Palm Beach County</div>
            <div class="county-status">Scraper Pending</div>
          </div>
          
          <div class="county-card pending" onclick="openCountyScraper('seminole')">
            <div class="status-dot"></div>
            <div class="county-icon">SEM</div>
            <div class="county-name">Seminole County</div>
            <div class="county-status">Scraper Pending</div>
          </div>
          
          <div class="county-card pending" onclick="openCountyScraper('orange')">
            <div class="status-dot"></div>
            <div class="county-icon">ORA</div>
            <div class="county-name">Orange County</div>
            <div class="county-status">Scraper Pending</div>
          </div>
          
          <div class="county-card pending" onclick="openCountyScraper('pinellas')">
            <div class="status-dot"></div>
            <div class="county-icon">PIN</div>
            <div class="county-name">Pinellas County</div>
            <div class="county-status">Scraper Pending</div>
          </div>
          
          <div class="county-card pending" onclick="openCountyScraper('broward')">
            <div class="status-dot"></div>
            <div class="county-icon">BRO</div>
            <div class="county-name">Broward County</div>
            <div class="county-status">Scraper Pending</div>
          </div>
          
          <div class="county-card pending" onclick="openCountyScraper('hillsborough')">
            <div class="status-dot"></div>
            <div class="county-icon">HIL</div>
            <div class="county-name">Hillsborough County</div>
            <div class="county-status">Scraper Pending</div>
          </div>
        </div>
        
        <!-- Bookmarklet Installation -->
        <div style="margin-top: 32px; padding: 24px; background: var(--surface-2); border-radius: var(--radius); border: 2px dashed var(--border);">
          <h4 style="margin-bottom: 12px; display: flex; align-items: center; gap: 10px;">
            <span>&#128204;</span> Install Bookmarklet
          </h4>
          <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 14px;">
            Drag this button to your bookmarks bar. When viewing a defendant's booking page, click the bookmarklet to copy their data.
          </p>
          <a href="javascript:(function(){/* Shamrock Scraper */var d=document,b={};try{b['defendant-first-name']=d.querySelector('[data-field=first-name]')?.textContent||'';b['defendant-last-name']=d.querySelector('[data-field=last-name]')?.textContent||'';b['defendant-dob']=d.querySelector('[data-field=dob]')?.textContent||'';b['defendant-booking-number']=d.querySelector('[data-field=booking]')?.textContent||'';b.charges=[];navigator.clipboard.writeText('bookingData='+JSON.stringify(b)+';');alert('Booking data copied!');}catch(e){alert('Error: '+e.message);}})();" 
             class="btn btn-primary" 
             style="cursor: grab;"
             onclick="event.preventDefault(); showToast('Drag this to your bookmarks bar!', 'info');">
            &#9752; Shamrock Scraper
          </a>
        </div>
      </div>
    </div>

    <!-- ============================================================
         TAB: CHARGES
         ============================================================ -->
    <div id="charges-tab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h3><span class="icon">&#9878;</span> Charges & Bond Information</h3>
          <button class="btn btn-primary" onclick="addCharge()">
            + Add Charge
          </button>
        </div>
        
        <div id="charges-container">
          <!-- Charges will be dynamically added here -->
        </div>
        
        <div id="no-charges-message" style="text-align: center; padding: 48px; color: var(--muted);">
          <p style="font-size: 48px; margin-bottom: 16px;">&#9878;</p>
          <p style="font-size: 16px; font-weight: 600;">No charges added yet</p>
          <p style="font-size: 14px; margin-top: 8px;">Click "Add Charge" to begin or paste booking data</p>
        </div>
      </div>
      
      <!-- Bond Summary -->
      <div class="summary-panel" id="bond-summary" style="display: none;">
        <div class="summary-grid">
          <div class="summary-item">
            <div class="label">Total Charges</div>
            <div class="value" id="total-charges-count">0</div>
          </div>
          <div class="summary-item">
            <div class="label">Total Bond Amount</div>
            <div class="value accent" id="total-bond-amount">$0.00</div>
          </div>
          <div class="summary-item">
            <div class="label">Premium (10%)</div>
            <div class="value" id="premium-amount">$0.00</div>
          </div>
          <div class="summary-item">
            <div class="label">Written Amount</div>
            <div class="value" id="bond-written" style="font-size: 14px;">Zero and 00/100</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================================
         TAB: DEFENDANT
         ============================================================ -->
    <div id="defendant-tab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h3><span class="icon">&#128100;</span> Defendant Information</h3>
          <button class="btn btn-secondary btn-sm" onclick="pasteBookingInfo()">
            &#128203; Paste from Clipboard
          </button>
        </div>
        
        <!-- Personal Information -->
        <h4 style="margin-bottom: 16px; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; color: var(--muted);">Personal Information</h4>
        
        <div class="form-row">
          <div class="form-group">
            <label class="required">First Name</label>
            <input type="text" id="defendant-first-name" placeholder="John" oninput="updateSummary()">
          </div>
          <div class="form-group">
            <label>Middle Name</label>
            <input type="text" id="defendant-middle-name" placeholder="Michael">
          </div>
          <div class="form-group">
            <label class="required">Last Name</label>
            <input type="text" id="defendant-last-name" placeholder="Doe" oninput="updateSummary()">
          </div>
          <div class="form-group">
            <label>Suffix</label>
            <select id="defendant-suffix">
              <option value="">None</option>
              <option value="Jr.">Jr.</option>
              <option value="Sr.">Sr.</option>
              <option value="II">II</option>
              <option value="III">III</option>
              <option value="IV">IV</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="required">Date of Birth</label>
            <input type="date" id="defendant-dob">
          </div>
          <div class="form-group">
            <label>SSN (Last 4)</label>
            <input type="text" id="defendant-ssn" placeholder="XXXX" maxlength="4">
          </div>
          <div class="form-group">
            <label>Driver's License #</label>
            <input type="text" id="defendant-dl-number" placeholder="D123-456-78-901">
          </div>
          <div class="form-group">
            <label>DL State</label>
            <select id="defendant-dl-state">
              <option value="FL">Florida</option>
              <option value="GA">Georgia</option>
              <option value="AL">Alabama</option>
              <option value="SC">South Carolina</option>
              <option value="NC">North Carolina</option>
            </select>
          </div>
        </div>
        
        <!-- Contact Information -->
        <h4 style="margin: 32px 0 16px; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; color: var(--muted);">Contact Information</h4>
        
        <div class="form-row">
          <div class="form-group" style="grid-column: span 2;">
            <label>Street Address</label>
            <input type="text" id="defendant-street-address" placeholder="123 Main Street">
          </div>
          <div class="form-group">
            <label>City</label>
            <input type="text" id="defendant-city" placeholder="Fort Myers">
          </div>
          <div class="form-group">
            <label>State</label>
            <select id="defendant-state">
              <option value="FL">Florida</option>
              <option value="GA">Georgia</option>
              <option value="AL">Alabama</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>ZIP Code</label>
            <input type="text" id="defendant-zipcode" placeholder="33901" maxlength="10">
          </div>
          <div class="form-group">
            <label>Phone</label>
            <input type="tel" id="defendant-phone" placeholder="(239) 555-1234">
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="defendant-email" placeholder="defendant@email.com">
          </div>
          <div class="form-group">
            <label>Booking Number</label>
            <input type="text" id="defendant-booking-number" placeholder="2024-123456">
          </div>
        </div>
        
        <!-- Jail/Court Information -->
        <h4 style="margin: 32px 0 16px; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; color: var(--muted);">Jail & Court Information</h4>
        
        <div class="form-row">
          <div class="form-group">
            <label>County</label>
            <select id="defendant-county" onchange="updateSummary()">
              <option value="Lee">Lee County</option>
              <option value="Collier">Collier County</option>
              <option value="Charlotte">Charlotte County</option>
              <option value="Sarasota">Sarasota County</option>
              <option value="Hendry">Hendry County</option>
              <option value="DeSoto">DeSoto County</option>
              <option value="Manatee">Manatee County</option>
              <option value="Palm Beach">Palm Beach County</option>
              <option value="Seminole">Seminole County</option>
              <option value="Orange">Orange County</option>
              <option value="Pinellas">Pinellas County</option>
              <option value="Broward">Broward County</option>
              <option value="Hillsborough">Hillsborough County</option>
            </select>
          </div>
          <div class="form-group">
            <label>Court Type</label>
            <select id="defendant-court-type">
              <option value="Co/Cir">County/Circuit</option>
              <option value="Circuit">Circuit Court</option>
              <option value="County">County Court</option>
              <option value="Federal">Federal Court</option>
            </select>
          </div>
          <div class="form-group">
            <label>Arrest Date</label>
            <input type="date" id="defendant-arrest-date">
          </div>
          <div class="form-group">
            <label>Jail Facility</label>
            <input type="text" id="defendant-jail-facility" placeholder="Lee County Jail">
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================================
         TAB: INDEMNITORS
         ============================================================ -->
    <div id="indemnitors-tab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h3><span class="icon">&#129309;</span> Indemnitors / Co-Signers</h3>
          <button class="btn btn-primary" onclick="addIndemnitor()">
            + Add Indemnitor
          </button>
        </div>
        
        <div id="indemnitors-container">
          <!-- Indemnitors will be dynamically added here -->
        </div>
        
        <div id="no-indemnitors-message" style="text-align: center; padding: 48px; color: var(--muted);">
          <p style="font-size: 48px; margin-bottom: 16px;">&#129309;</p>
          <p style="font-size: 16px; font-weight: 600;">No indemnitors added yet</p>
          <p style="font-size: 14px; margin-top: 8px;">Click "Add Indemnitor" to add a co-signer</p>
        </div>
      </div>
    </div>

    <!-- ============================================================
         TAB: PAYMENT
         ============================================================ -->
    <div id="payment-tab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h3><span class="icon">$</span> Payment Information</h3>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Premium Rate (%)</label>
            <select id="premium-rate" onchange="calculatePayment()">
              <option value="10">10% (Standard)</option>
              <option value="8">8% (Preferred)</option>
              <option value="5">5% (Special)</option>
              <option value="15">15% (High Risk)</option>
            </select>
          </div>
          <div class="form-group">
            <label>Down Payment</label>
            <input type="number" id="down-payment" placeholder="0.00" step="0.01" oninput="calculatePayment()">
          </div>
          <div class="form-group">
            <label>Payment Method</label>
            <select id="payment-method">
              <option value="cash">Cash</option>
              <option value="credit">Credit Card</option>
              <option value="debit">Debit Card</option>
              <option value="check">Check</option>
              <option value="money-order">Money Order</option>
              <option value="financing">Financing</option>
            </select>
          </div>
          <div class="form-group">
            <label>Agent Name</label>
            <input type="text" id="agent-name" placeholder="Agent Name" value="Shamrock Bail Bonds">
          </div>
        </div>
        
        <!-- Payment Summary -->
        <div style="margin-top: 24px; padding: 24px; background: var(--surface-2); border-radius: var(--radius); border: 2px solid var(--border);">
          <h4 style="margin-bottom: 20px;">Payment Summary</h4>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
            <div>
              <div style="font-size: 13px; color: var(--muted); margin-bottom: 4px;">Total Bond</div>
              <div style="font-size: 24px; font-weight: 700;" id="payment-total-bond">$0.00</div>
            </div>
            <div>
              <div style="font-size: 13px; color: var(--muted); margin-bottom: 4px;">Premium Due</div>
              <div style="font-size: 24px; font-weight: 700; color: var(--accent);" id="payment-premium-due">$0.00</div>
            </div>
            <div>
              <div style="font-size: 13px; color: var(--muted); margin-bottom: 4px;">Down Payment</div>
              <div style="font-size: 24px; font-weight: 700; color: var(--success);" id="payment-down">$0.00</div>
            </div>
            <div>
              <div style="font-size: 13px; color: var(--muted); margin-bottom: 4px;">Balance Due</div>
              <div style="font-size: 24px; font-weight: 700;" id="payment-balance" style="color: var(--error);">$0.00</div>
            </div>
          </div>
          
          <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
            <div style="font-size: 13px; color: var(--muted); margin-bottom: 4px;">Premium in Words</div>
            <div style="font-size: 16px; font-weight: 600; font-style: italic;" id="payment-premium-words">Zero and 00/100 Dollars</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================================
         TAB: DOCUMENTS
         ============================================================ -->
    <div id="documents-tab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h3><span class="icon">&#128196;</span> Document Selection</h3>
          <div style="display: flex; gap: 12px;">
            <button class="btn btn-secondary btn-sm" onclick="selectAllDocs()">Select All</button>
            <button class="btn btn-secondary btn-sm" onclick="selectDefaultDocs()">Default Set</button>
            <button class="btn btn-secondary btn-sm" onclick="deselectAllDocs()">Clear All</button>
          </div>
        </div>
        
        <p style="margin-bottom: 24px; color: var(--text-secondary); font-size: 14px;">
          Select which documents to include in the bail packet. Appearance bonds are automatically generated per charge.
        </p>
        
        <div class="doc-grid">
          <!-- Core Documents -->
          <label class="doc-item checked">
            <input type="checkbox" id="doc-paperwork-header" checked data-template="paperwork-header" onchange="toggleDocItem(this)">
            <div class="doc-info">
              <div class="doc-name">1. Paperwork Header</div>
              <div class="doc-meta">Cover page with defendant info</div>
            </div>
          </label>
          
          <label class="doc-item checked">
            <input type="checkbox" id="doc-faq-cosigners" checked data-template="faq-cosigners" onchange="toggleDocItem(this)">
            <div class="doc-info">
              <div class="doc-name">2. FAQ - Cosigners</div>
              <div class="doc-meta">Requires initials from all parties</div>
            </div>
          </label>
          
          <label class="doc-item checked">
            <input type="checkbox" id="doc-faq-defendants" checked data-template="faq-defendants" onchange="toggleDocItem(this)">
            <div class="doc-info">
              <div class="doc-name">3. FAQ - Defendants</div>
              <div class="doc-meta">Requires initials from all parties</div>
            </div>
          </label>
          
          <label class="doc-item checked">
            <input type="checkbox" id="doc-indemnity-agreement" checked data-template="indemnity-agreement" onchange="toggleDocItem(this)">
            <div class="doc-info">
              <div class="doc-name">4. Indemnity Agreement</div>
              <div class="doc-meta">Indemnitor fills out and signs</div>
            </div>
          </label>
          
          <label class="doc-item checked">
            <input type="checkbox" id="doc-defendant-application" checked data-template="defendant-application" onchange="toggleDocItem(this)">
            <div class="doc-info">
              <div class="doc-name">5. Defendant Application</div>
              <div class="doc-meta">Defendant fills out and signs</div>
            </div>
          </label>
          
          <label class="doc-item checked">
            <input type="checkbox" id="doc-promissory-note" checked data-template="promissory-note" onchange="toggleDocItem(this)">
            <div class="doc-info">
              <div class="doc-name">6. Promissory Note</div>
              <div class="doc-meta">Signatures by all parties</div>
            </div>
          </label>
          
          <label class="doc-item checked">
            <input type="checkbox" id="doc-surety-terms" checked data-template="surety-terms" onchange="toggleDocItem(this)">
            <div class="doc-info">
              <div class="doc-name">8. Surety Terms & Conditions</div>
              <div class="doc-meta">Signatures by all parties</div>
            </div>
          </label>
          
          <label class="doc-item checked">
            <input type="checkbox" id="doc-disclosure-form" checked data-template="disclosure-form" onchange="toggleDocItem(this)">
            <div class="doc-info">
              <div class="doc-name">7. Disclosure Form</div>
              <div class="doc-meta">Signatures by all parties</div>
            </div>
          </label>
          
          <label class="doc-item checked">
            <input type="checkbox" id="doc-master-waiver" checked data-template="master-waiver" onchange="toggleDocItem(this)">
            <div class="doc-info">
              <div class="doc-name">9. Master Waiver</div>
              <div class="doc-meta">Signatures by all parties</div>
            </div>
          </label>
          
          <label class="doc-item checked">
            <input type="checkbox" id="doc-ssa-release" checked data-template="ssa-release" onchange="toggleDocItem(this)">
            <div class="doc-info">
              <div class="doc-name">10. SSA Release Form</div>
              <div class="doc-meta">Signatures by all parties</div>
            </div>
          </label>
          
          <label class="doc-item checked">
            <input type="checkbox" id="doc-collateral-receipt" checked data-template="collateral-receipt" onchange="toggleDocItem(this)">
            <div class="doc-info">
              <div class="doc-name">11. Collateral/Premium Receipt</div>
              <div class="doc-meta">Auto-fills payment info, signature if collateral</div>
            </div>
          </label>
          
          <label class="doc-item" id="doc-payment-plan-item">
            <input type="checkbox" id="doc-payment-plan" data-template="payment-plan" onchange="toggleDocItem(this)">
            <div class="doc-info">
              <div class="doc-name">12. Payment Plan (Premium Finance)</div>
              <div class="doc-meta">Auto-selected if balance > $0</div>
            </div>
            <span class="doc-badge">If Balance</span>
          </label>
          
          <label class="doc-item checked" style="border-color: var(--warning); background: var(--warning-bg);">
            <input type="checkbox" id="doc-appearance-bonds" checked data-template="appearance-bond" onchange="toggleDocItem(this)">
            <div class="doc-info">
              <div class="doc-name">13. Appearance Bonds</div>
              <div class="doc-meta">PRINT ONLY - Agent signs with live signature</div>
            </div>
            <span class="doc-badge" style="background: var(--warning); color: #000;" id="appearance-bond-count">0 bonds</span>
          </label>
        </div>
        
        <!-- Document Count Summary -->
        <div style="margin-top: 24px; padding: 16px 20px; background: var(--surface-2); border-radius: var(--radius-sm); display: flex; justify-content: space-between; align-items: center;">
          <span style="font-weight: 600;"><span id="selected-doc-count">11</span> documents selected</span>
          <span style="color: var(--muted); font-size: 14px;">Estimated <span id="estimated-pages">~15</span> pages</span>
        </div>
      </div>
    </div>

    <!-- ============================================================
         TAB: GENERATE & SEND
         ============================================================ -->
    <div id="generate-tab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h3><span class="icon">&#9654;</span> Generate & Send to SignNow</h3>
        </div>
        
        <!-- Pre-flight Summary -->
        <div class="summary-panel" style="margin-bottom: 24px;">
          <div class="summary-grid">
            <div class="summary-item">
              <div class="label">Defendant</div>
              <div class="value" id="summary-defendant">--</div>
            </div>
            <div class="summary-item">
              <div class="label">Total Bond</div>
              <div class="value accent" id="summary-bond">$0.00</div>
            </div>
            <div class="summary-item">
              <div class="label">Charges</div>
              <div class="value" id="summary-charges">0</div>
            </div>
            <div class="summary-item">
              <div class="label">Documents</div>
              <div class="value" id="summary-docs">0</div>
            </div>
          </div>
        </div>
        
        <!-- Signing Configuration -->
        <h4 style="margin-bottom: 16px; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; color: var(--muted);">Signing Configuration</h4>
        
        <div class="form-row">
          <div class="form-group">
            <label class="required">Signing Method</label>
            <select id="signing-method" onchange="toggleSigningOptions()">
              <option value="email">&#128231; Send via Email</option>
              <option value="kiosk">&#128421; Kiosk Mode (In-Person)</option>
              <option value="download">&#8595; Download Only</option>
            </select>
          </div>
          <div class="form-group">
            <label>Email Subject</label>
            <input type="text" id="email-subject" value="Shamrock Bail Bonds - Documents for Signature">
          </div>
        </div>
        
        <!-- Email Recipients (shown for email mode) -->
        <div id="email-recipients-section">
          <h4 style="margin: 24px 0 16px; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; color: var(--muted);">Email Recipients</h4>
          
          <div style="background: var(--surface-2); border-radius: var(--radius); padding: 20px;">
            <div class="form-row">
              <div class="form-group">
                <label>Defendant Email</label>
                <input type="email" id="signer-defendant-email" placeholder="defendant@email.com">
              </div>
              <div class="form-group">
                <label>Indemnitor Email</label>
                <input type="email" id="signer-indemnitor-email" placeholder="indemnitor@email.com">
              </div>
            </div>
            <div id="additional-signer-emails"></div>
            <button class="btn btn-secondary btn-sm" onclick="addSignerEmail()" style="margin-top: 12px;">
              + Add Another Signer
            </button>
          </div>
        </div>
        
        <!-- Action Buttons -->
        <div style="margin-top: 32px; display: flex; gap: 16px; justify-content: center; flex-wrap: wrap;">
          <button class="btn btn-secondary btn-lg" onclick="previewPacket()">
            &#128065; Preview Packet
          </button>
          <button class="btn btn-success btn-lg" onclick="generateAndSend()" id="generate-btn">
            &#9654; Generate & Send to SignNow
          </button>
        </div>
        
        <!-- Result Area -->
        <div id="generate-result" style="margin-top: 24px;"></div>
      </div>
    </div>

    <!-- ============================================================
         TAB: STATUS
         ============================================================ -->
    <div id="status-tab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h3><span class="icon">&#128202;</span> SignNow Status Dashboard</h3>
          <button class="btn btn-secondary btn-sm" onclick="refreshStatus()">
            &#128260; Refresh
          </button>
        </div>
        
        <div id="status-container">
          <div style="text-align: center; padding: 48px; color: var(--muted);">
            <p style="font-size: 48px; margin-bottom: 16px;">&#128202;</p>
            <p style="font-size: 16px; font-weight: 600;">No packets sent yet</p>
            <p style="font-size: 14px; margin-top: 8px;">Generate and send a packet to see status here</p>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- FLOATING ACTION BUTTONS -->
  <div class="fab-container">
    <button class="fab secondary" onclick="showKeyboardShortcuts()" title="Keyboard Shortcuts">?</button>
    <button class="fab secondary" onclick="saveFormToLocalStorage(); showToast('Form saved!', 'success')" title="Quick Save">&#128190;</button>
    <button class="fab danger" onclick="confirmClearAll()" title="Clear All">&#128465;</button>
    <button class="fab" onclick="pasteBookingInfo()" title="Paste Booking Data">&#128203;</button>
  </div>


  <script>
    /* =========================================================
       CONFIGURATION
       ========================================================= */
    const CONFIG = {
      gasWebAppUrl: 'https://script.google.com/macros/s/AKfycbxHPq6lDHT3SI2Lx3fKPc-Kf_fsyo-f5SI-8Byoy-CIG7x2FjUfkSK23ceu6lodccHPjg/exec', // UPDATE WITH YOUR DEPLOYED URL
      signNowApiBase: 'https://api.signnow.com',
      signNowToken: '0c35edbbf6823555a8434624aaec4830fd4477bb5befee3da2fa29e2b258913d',
      
      // Google Drive Template IDs (from your Templates folder)
      // NOTE: appearance-bond is PRINT ONLY - does NOT go to SignNow
      templates: {
        'paperwork-header': '15sTaIIwhzHk96I8X3rxz7GtLMU-F5zo1',
        'faq-cosigners': '1bjmH2w-XS5Hhe828y_Jmv9DqaS_gSZM7',
        'faq-defendants': '16j9Z8eTii-J_p4o6A2LrzgzptGB8aOhR',
        'indemnity-agreement': '1p4bYIiZ__JnJHhlmVwLyPJZpsmSdGq12',
        'defendant-application': '1cokWm8qCDpiGxYD6suZEjm9i8MoABeVe',
        'promissory-note': '104-ArZiCm3cgfQcT5rIO0x_OWiaw6Ddt',
        'disclosure-form': '1qIIDudp7r3J7-6MHlL2US34RcrU9KZKY',
        'surety-terms': '1VfmyUTpchfwJTlENlR72JxmoE_NCF-uf',
        'master-waiver': '181mgKQN-VxvQOyzDquFs8cFHUN0tjrMs',
        'ssa-release': '1govKv_N1wl0FIePV8Xfa8mFmZ9JT8mNu',
        'collateral-receipt': '1IAYq4H2b0N0vPnJN7b2vZPaHg_RNKCmP',
        'payment-plan': '1v-qkaegm6MDymiaPK45JqfXXX2_KOj8A',
        'appearance-bond': '15SDM1oBysTw76bIL7Xt0Uhti8uRZKABs'  // PRINT ONLY - does NOT go to SignNow
      },
      
      // Document order for SignNow packet (appearance-bond excluded - print only)
      // This is the order documents should be assembled and signed
      templateOrder: [
        'paperwork-header',      // 1. Header with names, case number, date
        'faq-cosigners',         // 2. FAQ for co-signers (initials)
        'faq-defendants',        // 3. FAQ for defendants (initials)
        'indemnity-agreement',   // 4. Indemnitor fills out and signs
        'defendant-application', // 5. Defendant fills out and signs
        'promissory-note',       // 6. Signatures by all parties
        'disclosure-form',       // 7. Signatures by all parties
        'surety-terms',          // 8. Signatures by all parties
        'master-waiver',         // 9. Signatures by all parties
        'ssa-release',           // 10. Signatures by all parties
        'collateral-receipt',    // 11. Collateral and premium receipt
        'payment-plan'           // 12. Only if payment plan is used
      ],
      
      // Documents that require print only (not sent to SignNow)
      printOnlyDocs: ['appearance-bond'],
      
      // County scraper URLs
      countyUrls: {
        'lee': 'https://www.sheriffleefl.org/booking-search/',
        'collier': 'https://www2.colliersheriff.org/arrestsearch/',
        'charlotte': 'https://ccso.org/correctional_facility/local_arrest_database.php',
        'hendry': 'https://www.hendrysheriff.org/inmateSearch',
        'glades': 'https://smartweb.gladessheriff.org/smartwebclient/Jail.aspx',
        'sarasota': 'https://www.sarasotasheriff.org/inmate-search/',
        'desoto': 'https://www.desotosheriff.com/inmate-search',
        'manatee': 'https://www.manateesheriff.com/InmateSearch',
        'palm-beach': 'https://www.pbso.org/inmate-search',
        'seminole': 'https://www.seminolesheriff.org/inmate-search',
        'orange': 'https://www.ocfl.net/JailInmateSearch',
        'pinellas': 'https://www.pcsoweb.com/InmateBooking',
        'broward': 'https://www.sheriff.org/InmateSearch',
        'hillsborough': 'https://webapps.hcso.tampa.fl.us/arrestinquiry'
      }
    };

    /* =========================================================
       GLOBAL STATE
       ========================================================= */
    let chargeCount = 0;
    let indemnitorCount = 0;
    let currentReceiptNumber = 201204;
    let sentPackets = [];

    const LS_KEY_FORM = 'shamrock_form_v4';
    const LS_KEY_THEME = 'shamrock_theme';
    const LS_KEY_MODE = 'shamrock_mode';
    const LS_KEY_RECEIPT = 'shamrock_receipt';
    const LS_KEY_PACKETS = 'shamrock_packets';

    /* =========================================================
       PHONE NUMBER AUTO-FORMATTING
       ========================================================= */
    function formatPhoneNumber(value) {
      // Remove all non-digit characters
      const digits = value.replace(/\D/g, '');
      
      // Format based on length
      if (digits.length === 0) return '';
      if (digits.length <= 3) return `(${digits}`;
      if (digits.length <= 6) return `(${digits.slice(0, 3)}) ${digits.slice(3)}`;
      if (digits.length <= 10) return `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6)}`;
      // If more than 10 digits, truncate
      return `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6, 10)}`;
    }

    function setupPhoneFormatting() {
      // Format all phone inputs on blur and input
      document.addEventListener('blur', function(e) {
        if (e.target.type === 'tel') {
          e.target.value = formatPhoneNumber(e.target.value);
        }
      }, true);
      
      // Also format on input for live feedback
      document.addEventListener('input', function(e) {
        if (e.target.type === 'tel') {
          const cursorPos = e.target.selectionStart;
          const oldLength = e.target.value.length;
          e.target.value = formatPhoneNumber(e.target.value);
          const newLength = e.target.value.length;
          // Adjust cursor position
          const newPos = cursorPos + (newLength - oldLength);
          e.target.setSelectionRange(newPos, newPos);
        }
      }, true);
    }

    /* =========================================================
       ADDRESS AUTOCOMPLETE (Google Places API)
       ========================================================= */
    function setupAddressAutocomplete() {
      // Check if Google Places API is loaded
      if (typeof google === 'undefined' || !google.maps || !google.maps.places) {
        console.warn('Google Places API not loaded - address autocomplete disabled');
        return;
      }
      
      // Setup for defendant address
      setupAddressField('defendant-street-address', 'defendant-city', 'defendant-state', 'defendant-zipcode');
      
      // Setup for dynamically added indemnitor addresses using event delegation
      document.addEventListener('focus', function(e) {
        if (e.target.id && e.target.id.match(/indemnitor-\d+-street-address/) && !e.target.dataset.autocompleteInit) {
          const match = e.target.id.match(/indemnitor-(\d+)-street-address/);
          if (match) {
            const num = match[1];
            setupAddressField(
              `indemnitor-${num}-street-address`,
              `indemnitor-${num}-city`,
              `indemnitor-${num}-state`,
              `indemnitor-${num}-zipcode`
            );
            e.target.dataset.autocompleteInit = 'true';
          }
        }
      }, true);
    }
    
    function setupAddressField(streetId, cityId, stateId, zipId) {
      const streetInput = document.getElementById(streetId);
      if (!streetInput) return;
      
      const autocomplete = new google.maps.places.Autocomplete(streetInput, {
        types: ['address'],
        componentRestrictions: { country: 'us' },
        fields: ['address_components', 'formatted_address']
      });
      
      autocomplete.addListener('place_changed', function() {
        const place = autocomplete.getPlace();
        if (!place.address_components) return;
        
        let streetNumber = '';
        let streetName = '';
        let city = '';
        let state = '';
        let zip = '';
        
        for (const component of place.address_components) {
          const type = component.types[0];
          switch (type) {
            case 'street_number':
              streetNumber = component.long_name;
              break;
            case 'route':
              streetName = component.long_name;
              break;
            case 'locality':
            case 'sublocality_level_1':
              city = component.long_name;
              break;
            case 'administrative_area_level_1':
              state = component.short_name;
              break;
            case 'postal_code':
              zip = component.long_name;
              break;
          }
        }
        
        // Fill in the fields
        streetInput.value = `${streetNumber} ${streetName}`.trim();
        
        const cityInput = document.getElementById(cityId);
        if (cityInput) cityInput.value = city;
        
        const stateInput = document.getElementById(stateId);
        if (stateInput) stateInput.value = state;
        
        const zipInput = document.getElementById(zipId);
        if (zipInput) zipInput.value = zip;
        
        showToast('Address auto-filled!', 'success');
      });
    }

    /* =========================================================
       INITIALIZATION
       ========================================================= */
    document.addEventListener('DOMContentLoaded', function() {
      // Restore theme and mode
      const savedTheme = localStorage.getItem(LS_KEY_THEME) || 'tuxedo';
      const savedMode = localStorage.getItem(LS_KEY_MODE) || 'dark';
      applyTheme(savedTheme);
      applyMode(savedMode);
      
      // Restore receipt number
      const savedReceipt = localStorage.getItem(LS_KEY_RECEIPT);
      if (savedReceipt) currentReceiptNumber = parseInt(savedReceipt);
      updateReceiptDisplay();
      
      // Restore sent packets
      const savedPackets = localStorage.getItem(LS_KEY_PACKETS);
      if (savedPackets) sentPackets = JSON.parse(savedPackets);
      
      // Restore form data
      loadFormFromLocalStorage();
      
      // Set up keyboard shortcuts
      setupKeyboardShortcuts();
      
      // Set up paste listener
      document.addEventListener('paste', handlePaste);
      
      // Set up phone number auto-formatting
      setupPhoneFormatting();
      
      // Set up address autocomplete
      setupAddressAutocomplete();
      
      // Update summary
      updateSummary();
      updateDocumentCount();
      
      // Initialize county statistics
      initCountyStats();
      
      console.log('&#9752; Shamrock Bail Bonds Control Center initialized');
    });

    /* =========================================================
       THEME & MODE MANAGEMENT
       ========================================================= */
    function applyTheme(theme) {
      document.body.setAttribute('data-theme', theme);
      localStorage.setItem(LS_KEY_THEME, theme);
      const select = document.getElementById('theme-select');
      if (select) select.value = theme;
    }

    function applyMode(mode) {
      document.body.setAttribute('data-mode', mode);
      localStorage.setItem(LS_KEY_MODE, mode);
      const icon = document.getElementById('mode-icon');
      const text = document.getElementById('mode-text');
      if (icon) icon.textContent = mode === 'dark' ? 'Light' : 'Dark';
      if (text) text.textContent = mode === 'dark' ? 'Light' : 'Dark';
    }

    function toggleMode() {
      const current = document.body.getAttribute('data-mode');
      applyMode(current === 'dark' ? 'light' : 'dark');
    }

    /* =========================================================
       TAB NAVIGATION
       ========================================================= */
    function switchTab(btn, tabId) {
      // Update tab buttons
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      if (btn) btn.classList.add('active');
      else document.querySelector(`[onclick*="${tabId}"]`)?.classList.add('active');
      
      // Update tab content
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById(`${tabId}-tab`)?.classList.add('active');
    }

    /* =========================================================
       COUNTY SCRAPERS & STATISTICS
       ========================================================= */
    
    /**
     * Open the county booking blotter in a new tab
     */
    function openCountyScraper(county) {
      const url = CONFIG.countyUrls[county];
      if (url) {
        window.open(url, '_blank');
        showToast(`Opening ${county.charAt(0).toUpperCase() + county.slice(1)} County booking blotter`, 'info');
      } else {
        showToast(`Scraper for ${county} is coming soon!`, 'warning');
      }
    }

    /**
     * Fetch and display arrest statistics for all active counties
     */
    function refreshAllCountyStatus() {
      showToast('Fetching arrest statistics...', 'info');
      
      // Call GAS backend to get today's arrest statistics
      google.script.run
        .withSuccessHandler(function(stats) {
          if (stats && typeof stats === 'object') {
            updateCountyStats(stats);
            showToast('Statistics updated!', 'success');
          } else {
            showToast('No statistics available', 'warning');
          }
        })
        .withFailureHandler(function(error) {
          console.error('Failed to fetch county stats:', error);
          showToast('Failed to fetch statistics', 'error');
          // Load sample data for demonstration
          loadSampleCountyStats();
        })
        .getCountyStatistics();
    }

    /**
     * Update the county cards with statistics data
     * @param {Object} stats - Statistics object keyed by county name
     */
    function updateCountyStats(stats) {
      const counties = ['lee', 'collier', 'charlotte'];
      
      counties.forEach(county => {
        const countyStats = stats[county] || {};
        
        // Update total arrests
        const totalEl = document.getElementById(`${county}-total`);
        if (totalEl) totalEl.textContent = countyStats.total || '0';
        
        // Update male/female breakdown
        const maleEl = document.getElementById(`${county}-male`);
        const femaleEl = document.getElementById(`${county}-female`);
        if (maleEl) maleEl.textContent = countyStats.male || '0';
        if (femaleEl) femaleEl.textContent = countyStats.female || '0';
        
        // Update average bond
        const avgBondEl = document.getElementById(`${county}-avg-bond`);
        if (avgBondEl) {
          const avgBond = countyStats.avgBond || 0;
          avgBondEl.textContent = avgBond > 0 ? formatCurrency(avgBond) : '--';
        }
        
        // Update crime breakdown tags
        const crimesEl = document.getElementById(`${county}-crimes`);
        if (crimesEl && countyStats.crimes) {
          crimesEl.innerHTML = '';
          const topCrimes = Object.entries(countyStats.crimes)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 4);
          
          topCrimes.forEach(([crime, count]) => {
            const tag = document.createElement('span');
            tag.className = 'crime-tag';
            tag.textContent = `${crime}: ${count}`;
            crimesEl.appendChild(tag);
          });
        }
      });
    }

    /**
     * Load sample statistics for demonstration when GAS is unavailable
     */
    function loadSampleCountyStats() {
      const sampleStats = {
        lee: {
          total: 47,
          male: 38,
          female: 9,
          avgBond: 5250,
          crimes: { 'DUI': 8, 'Battery': 12, 'Theft': 6, 'Drug': 15 }
        },
        collier: {
          total: 23,
          male: 19,
          female: 4,
          avgBond: 7500,
          crimes: { 'DUI': 5, 'Battery': 7, 'Theft': 3, 'Drug': 6 }
        },
        charlotte: {
          total: 15,
          male: 12,
          female: 3,
          avgBond: 3500,
          crimes: { 'DUI': 3, 'Battery': 5, 'Theft': 2, 'Drug': 4 }
        }
      };
      
      updateCountyStats(sampleStats);
      showToast('Loaded sample statistics (GAS unavailable)', 'info');
    }

    /**
     * Initialize county statistics on page load
     */
    function initCountyStats() {
      // Try to load stats on page load
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        refreshAllCountyStatus();
      } else {
        // Running outside GAS environment, load sample data
        loadSampleCountyStats();
      }
    }

    /* =========================================================
       CHARGE MANAGEMENT
       ========================================================= */
    function addCharge(data = {}) {
      chargeCount++;
      const container = document.getElementById('charges-container');
      const noChargesMsg = document.getElementById('no-charges-message');
      const bondSummary = document.getElementById('bond-summary');
      
      if (noChargesMsg) noChargesMsg.style.display = 'none';
      if (bondSummary) bondSummary.style.display = 'block';
      
      const chargeHtml = `
        <div class="entity-card charge" id="charge-${chargeCount}">
          <div class="entity-header">
            <h4>
              <span class="entity-number">${chargeCount}</span>
              Charge ${chargeCount}
            </h4>
            <button class="btn-remove" onclick="removeCharge(${chargeCount})"></button>
          </div>
          <div class="form-row">
            <div class="form-group" style="grid-column: span 2;">
              <label class="required">Charge Description</label>
              <input type="text" id="charge-${chargeCount}-desc" placeholder="e.g., Battery - Domestic Violence" 
                     value="${data.desc || ''}" oninput="updateSummary()">
            </div>
            <div class="form-group">
              <label>Statute</label>
              <input type="text" id="charge-${chargeCount}-statute" placeholder="784.03(1)(a)" value="${data.statute || ''}">
            </div>
            <div class="form-group">
              <label>Degree</label>
              <select id="charge-${chargeCount}-degree">
                <option value="M1" ${data.degree === 'M1' ? 'selected' : ''}>1st Degree Misdemeanor</option>
                <option value="M2" ${data.degree === 'M2' ? 'selected' : ''}>2nd Degree Misdemeanor</option>
                <option value="F3" ${data.degree === 'F3' ? 'selected' : ''}>3rd Degree Felony</option>
                <option value="F2" ${data.degree === 'F2' ? 'selected' : ''}>2nd Degree Felony</option>
                <option value="F1" ${data.degree === 'F1' ? 'selected' : ''}>1st Degree Felony</option>
                <option value="PBL" ${data.degree === 'PBL' ? 'selected' : ''}>Life Felony</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Case Number</label>
              <input type="text" id="charge-${chargeCount}-case" placeholder="24-CF-001234" value="${data.caseNumber || ''}">
            </div>
            <div class="form-group">
              <label>Power Number</label>
              <input type="text" id="charge-${chargeCount}-power" placeholder="OSI3-4591234" value="${data.powerNumber || ''}">
            </div>
            <div class="form-group">
              <label class="required">Bond Amount</label>
              <input type="number" id="charge-${chargeCount}-bond" placeholder="5000.00" step="0.01" 
                     value="${data.bondAmount || ''}" oninput="updateSummary()">
            </div>
            <div class="form-group">
              <label>Bond Type</label>
              <select id="charge-${chargeCount}-bond-type">
                <option value="surety" ${data.bondType === 'surety' ? 'selected' : ''}>Surety Bond</option>
                <option value="cash" ${data.bondType === 'cash' ? 'selected' : ''}>Cash Bond</option>
                <option value="property" ${data.bondType === 'property' ? 'selected' : ''}>Property Bond</option>
              </select>
            </div>
          </div>
        </div>
      `;
      
      container.insertAdjacentHTML('beforeend', chargeHtml);
      updateBadges();
      updateSummary();
    }

    function removeCharge(num) {
      const el = document.getElementById(`charge-${num}`);
      if (el) {
        el.remove();
        updateBadges();
        updateSummary();
        
        // Show no charges message if empty
        const container = document.getElementById('charges-container');
        if (container.children.length === 0) {
          document.getElementById('no-charges-message').style.display = 'block';
          document.getElementById('bond-summary').style.display = 'none';
        }
      }
    }

    /* =========================================================
       INDEMNITOR MANAGEMENT
       ========================================================= */
    function addIndemnitor(data = {}) {
      indemnitorCount++;
      const container = document.getElementById('indemnitors-container');
      const noIndMsg = document.getElementById('no-indemnitors-message');
      
      if (noIndMsg) noIndMsg.style.display = 'none';
      
      const indemnitorHtml = `
        <div class="entity-card indemnitor" id="indemnitor-${indemnitorCount}">
          <div class="entity-header">
            <h4>
              <span class="entity-number" style="background: var(--success);">${indemnitorCount}</span>
              Indemnitor ${indemnitorCount}
            </h4>
            <button class="btn-remove" onclick="removeIndemnitor(${indemnitorCount})"></button>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="required">First Name</label>
              <input type="text" id="indemnitor-${indemnitorCount}-first" placeholder="Jane" value="${data.firstName || ''}">
            </div>
            <div class="form-group">
              <label>Middle Name</label>
              <input type="text" id="indemnitor-${indemnitorCount}-middle" placeholder="Marie" value="${data.middleName || ''}">
            </div>
            <div class="form-group">
              <label class="required">Last Name</label>
              <input type="text" id="indemnitor-${indemnitorCount}-last" placeholder="Smith" value="${data.lastName || ''}">
            </div>
            <div class="form-group">
              <label>Relationship</label>
              <select id="indemnitor-${indemnitorCount}-relationship">
                <option value="spouse">Spouse</option>
                <option value="parent">Parent</option>
                <option value="sibling">Sibling</option>
                <option value="friend">Friend</option>
                <option value="employer">Employer</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Date of Birth</label>
              <input type="date" id="indemnitor-${indemnitorCount}-dob" value="${data.dob || ''}">
            </div>
            <div class="form-group">
              <label>SSN (Last 4)</label>
              <input type="text" id="indemnitor-${indemnitorCount}-ssn" placeholder="XXXX" maxlength="4" value="${data.ssn || ''}">
            </div>
            <div class="form-group">
              <label>Driver's License #</label>
              <input type="text" id="indemnitor-${indemnitorCount}-dl" placeholder="D123-456-78-901" value="${data.dl || ''}">
            </div>
            <div class="form-group">
              <label>DL State</label>
              <select id="indemnitor-${indemnitorCount}-dl-state">
                <option value="FL">Florida</option>
                <option value="GA">Georgia</option>
                <option value="AL">Alabama</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group" style="grid-column: span 2;">
              <label>Street Address</label>
              <input type="text" id="indemnitor-${indemnitorCount}-address" placeholder="456 Oak Street" value="${data.address || ''}">
            </div>
            <div class="form-group">
              <label>City</label>
              <input type="text" id="indemnitor-${indemnitorCount}-city" placeholder="Fort Myers" value="${data.city || ''}">
            </div>
            <div class="form-group">
              <label>ZIP</label>
              <input type="text" id="indemnitor-${indemnitorCount}-zip" placeholder="33901" value="${data.zip || ''}">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Phone</label>
              <input type="tel" id="indemnitor-${indemnitorCount}-phone" placeholder="(239) 555-5678" value="${data.phone || ''}">
            </div>
            <div class="form-group">
              <label>Email</label>
              <input type="email" id="indemnitor-${indemnitorCount}-email" placeholder="indemnitor@email.com" value="${data.email || ''}">
            </div>
            <div class="form-group">
              <label>Employer</label>
              <input type="text" id="indemnitor-${indemnitorCount}-employer" placeholder="ABC Company" value="${data.employer || ''}">
            </div>
            <div class="form-group">
              <label>Employer Phone</label>
              <input type="tel" id="indemnitor-${indemnitorCount}-employer-phone" placeholder="(239) 555-9999" value="${data.employerPhone || ''}">
            </div>
          </div>
        </div>
      `;
      
      container.insertAdjacentHTML('beforeend', indemnitorHtml);
      updateBadges();
    }

    function removeIndemnitor(num) {
      const el = document.getElementById(`indemnitor-${num}`);
      if (el) {
        el.remove();
        updateBadges();
        
        const container = document.getElementById('indemnitors-container');
        if (container.children.length === 0) {
          document.getElementById('no-indemnitors-message').style.display = 'block';
        }
      }
    }

    /* =========================================================
       DOCUMENT SELECTION
       ========================================================= */
    function toggleDocItem(checkbox) {
      const item = checkbox.closest('.doc-item');
      if (checkbox.checked) {
        item.classList.add('checked');
      } else {
        item.classList.remove('checked');
      }
      updateDocumentCount();
    }

    function selectAllDocs() {
      document.querySelectorAll('.doc-item input[type="checkbox"]').forEach(cb => {
        cb.checked = true;
        cb.closest('.doc-item').classList.add('checked');
      });
      updateDocumentCount();
    }

    function deselectAllDocs() {
      document.querySelectorAll('.doc-item input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
        cb.closest('.doc-item').classList.remove('checked');
      });
      updateDocumentCount();
    }

    function selectDefaultDocs() {
      deselectAllDocs();
      const defaults = ['paperwork-header', 'faq-cosigners', 'faq-defendants', 'indemnity-agreement', 
                        'promissory-note', 'surety-terms', 'disclosure-form', 'master-waiver',
                        'ssa-defendant', 'ssa-indemnitor', 'collateral-receipt', 'appearance-bonds'];
      defaults.forEach(id => {
        const cb = document.getElementById(`doc-${id}`);
        if (cb) {
          cb.checked = true;
          cb.closest('.doc-item').classList.add('checked');
        }
      });
      updateDocumentCount();
    }

    function updateDocumentCount() {
      const checked = document.querySelectorAll('.doc-item input[type="checkbox"]:checked').length;
      const chargeCards = document.querySelectorAll('.entity-card.charge').length;
      
      document.getElementById('selected-doc-count').textContent = checked;
      document.getElementById('appearance-bond-count').textContent = `${chargeCards} bonds`;
      document.getElementById('estimated-pages').textContent = `~${checked * 1.5 + chargeCards}`;
      document.getElementById('summary-docs').textContent = checked;
    }

    /* =========================================================
       CALCULATIONS
       ========================================================= */
    function calculateTotalBond() {
      let total = 0;
      document.querySelectorAll('[id^="charge-"][id$="-bond"]').forEach(input => {
        const val = parseFloat(input.value) || 0;
        total += val;
      });
      return total;
    }

    /**
     * Calculate premium for a single charge with $100 minimum rule
     * Florida law: Premium is 10% of bond amount, but minimum $100 per charge
     * If bond <= $1,000: Premium = $100 (flat)
     * If bond > $1,000: Premium = 10% of bond amount
     * @param {number} bondAmount - The bond amount for a single charge
     * @param {number} rate - Premium rate (default 10%)
     * @returns {number} - Premium amount (minimum $100 per charge)
     */
    function calculatePremium(bondAmount, rate = 10) {
      if (bondAmount <= 0) return 0;
      // If bond is $1,000 or less, minimum premium is $100
      if (bondAmount <= 1000) return 100;
      // If bond is over $1,000, premium is 10%
      return bondAmount * (rate / 100);
    }

    /**
     * Calculate total premium across all charges
     * Each charge has a $100 minimum premium (for bonds $1,000 or less)
     * @returns {number} - Total premium for all charges
     */
    function calculateTotalPremium() {
      let totalPremium = 0;
      const rate = parseFloat(document.getElementById('premium-rate')?.value || 10);
      
      document.querySelectorAll('[id^="charge-"][id$="-bond"]').forEach(input => {
        const bondAmount = parseFloat(input.value) || 0;
        if (bondAmount > 0) {
          // Apply $100 minimum per charge (for bonds $1,000 or less)
          const chargePremium = calculatePremium(bondAmount, rate);
          totalPremium += chargePremium;
        }
      });
      
      return totalPremium;
    }

    function numberToWords(num) {
      // Handle edge cases that could cause erroneous output
      if (num === null || num === undefined || isNaN(num)) return 'Zero';
      if (num === 0) return 'Zero';
      if (num < 0) return 'Zero'; // Don't allow negative numbers
      
      num = Math.floor(num); // Ensure we're working with integers
      if (num === 0) return 'Zero';
      
      const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine',
                    'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen',
                    'Seventeen', 'Eighteen', 'Nineteen'];
      const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
      const scales = ['', 'Thousand', 'Million', 'Billion'];
      
      function convertHundreds(n) {
        let result = '';
        if (n >= 100) {
          result += ones[Math.floor(n / 100)] + ' Hundred ';
          n %= 100;
        }
        if (n >= 20) {
          result += tens[Math.floor(n / 10)] + ' ';
          n %= 10;
        }
        if (n > 0) {
          result += ones[n] + ' ';
        }
        return result;
      }
      
      let result = '';
      let scaleIndex = 0;
      
      while (num > 0) {
        const chunk = num % 1000;
        if (chunk > 0) {
          result = convertHundreds(chunk) + scales[scaleIndex] + ' ' + result;
        }
        num = Math.floor(num / 1000);
        scaleIndex++;
      }
      
      return result.trim() || 'Zero';
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
    }

    function calculatePayment() {
      const totalBond = calculateTotalBond();
      const downPayment = parseFloat(document.getElementById('down-payment')?.value || 0);
      // Use calculateTotalPremium which applies $100 minimum per charge
      const premium = calculateTotalPremium();
      const balance = premium - downPayment;
      
      document.getElementById('payment-total-bond').textContent = formatCurrency(totalBond);
      document.getElementById('payment-premium-due').textContent = formatCurrency(premium);
      document.getElementById('payment-down').textContent = formatCurrency(downPayment);
      document.getElementById('payment-balance').textContent = formatCurrency(Math.max(0, balance));
      document.getElementById('payment-premium-words').textContent = numberToWords(Math.floor(premium)) + ' and ' + 
        String(Math.round((premium % 1) * 100)).padStart(2, '0') + '/100 Dollars';
      
      // Auto-select payment plan if balance > 0
      const paymentPlanCb = document.getElementById('doc-payment-plan');
      if (paymentPlanCb) {
        if (balance > 0) {
          paymentPlanCb.checked = true;
          paymentPlanCb.closest('.doc-item').classList.add('checked');
        }
      }
    }

    /* =========================================================
       SUMMARY UPDATES
       ========================================================= */
    function updateSummary() {
      const firstName = document.getElementById('defendant-first-name')?.value || '';
      const lastName = document.getElementById('defendant-last-name')?.value || '';
      const totalBond = calculateTotalBond();
      const chargeCards = document.querySelectorAll('.entity-card.charge').length;
      // Use calculateTotalPremium which applies $100 minimum per charge
      const premium = calculateTotalPremium();
      
      // Update summary displays
      document.getElementById('summary-defendant').textContent = 
        firstName && lastName ? `${firstName} ${lastName}` : '--';
      document.getElementById('summary-bond').textContent = formatCurrency(totalBond);
      document.getElementById('summary-charges').textContent = chargeCards;
      
      // Update bond summary panel
      document.getElementById('total-charges-count').textContent = chargeCards;
      document.getElementById('total-bond-amount').textContent = formatCurrency(totalBond);
      document.getElementById('premium-amount').textContent = formatCurrency(premium);
      document.getElementById('bond-written').textContent = 
        numberToWords(Math.floor(totalBond)) + ' and 00/100 Dollars';
      
      calculatePayment();
      updateDocumentCount();
    }

    function updateBadges() {
      const chargeCards = document.querySelectorAll('.entity-card.charge').length;
      const indemnitorCards = document.querySelectorAll('.entity-card.indemnitor').length;
      
      const chargesBadge = document.getElementById('charges-badge');
      const indemnitorsBadge = document.getElementById('indemnitors-badge');
      
      if (chargesBadge) {
        chargesBadge.textContent = chargeCards;
        chargesBadge.style.display = chargeCards > 0 ? 'inline' : 'none';
      }
      
      if (indemnitorsBadge) {
        indemnitorsBadge.textContent = indemnitorCards;
        indemnitorsBadge.style.display = indemnitorCards > 0 ? 'inline' : 'none';
      }
    }

    function updateReceiptDisplay() {
      const display = document.getElementById('receipt-display');
      if (display) display.textContent = currentReceiptNumber;
    }

    /* =========================================================
       PASTE HANDLING
       ========================================================= */
    function handlePaste(e) {
      const text = e.clipboardData?.getData('text');
      if (text && (text.includes('bookingData') || text.includes('defendant-'))) {
        e.preventDefault();
        importBookingData(text);
      }
    }

    async function pasteBookingInfo() {
      try {
        const text = await navigator.clipboard.readText();
        if (text) {
          importBookingData(text);
        } else {
          showToast('No data found in clipboard', 'warning');
        }
      } catch (err) {
        showToast('Please paste (Ctrl+V) the booking data anywhere on the form', 'info');
      }
    }

    function importBookingData(dataString) {
      try {
        let data;
        if (dataString.includes('bookingData')) {
          const match = dataString.match(/bookingData\s*=\s*({[\s\S]*?});/);
          if (match) data = JSON.parse(match[1]);
        } else {
          data = JSON.parse(dataString);
        }
        
        if (!data) {
          showToast('Invalid booking data format', 'error');
          return;
        }
        
        console.log('Imported data:', data);
        
        // Helper function to get value from multiple possible keys
        function getValue(...keys) {
          for (const key of keys) {
            if (data[key] !== undefined && data[key] !== null && data[key] !== '') {
              return data[key];
            }
          }
          return '';
        }
        
        // Parse name if it's in "LAST, FIRST MIDDLE" format
        let firstName = '', middleName = '', lastName = '';
        const fullName = getValue('defendantFullName', 'defendant-name', 'defendantName', 'name', 'Name');
        if (fullName && fullName.includes(',')) {
          const parts = fullName.split(',').map(s => s.trim());
          lastName = parts[0] || '';
          if (parts[1]) {
            const nameParts = parts[1].split(' ').filter(s => s);
            firstName = nameParts[0] || '';
            middleName = nameParts.slice(1).join(' ') || '';
          }
        } else {
          firstName = getValue('defendant-first-name', 'firstName', 'first_name', 'first-name');
          middleName = getValue('defendant-middle-name', 'middleName', 'middle_name', 'middle-name');
          lastName = getValue('defendant-last-name', 'lastName', 'last_name', 'last-name');
        }
        
        // Parse address if it's a full string
        let streetAddress = '', city = '', state = 'FL', zipcode = '';
        const fullAddress = getValue('defendant-address', 'address', 'Address');
        if (fullAddress) {
          // Try to parse: "1759 Four Mile Cove Pkwy APT 411 Cape Coral FL 33990"
          const addressMatch = fullAddress.match(/^(.+?)\s+([A-Za-z\s]+),?\s*([A-Z]{2})\s*(\d{5}(?:-\d{4})?)$/);
          if (addressMatch) {
            streetAddress = addressMatch[1].trim();
            city = addressMatch[2].trim();
            state = addressMatch[3].trim();
            zipcode = addressMatch[4].trim();
          } else {
            // Try simpler parsing
            const parts = fullAddress.split(',').map(s => s.trim());
            if (parts.length >= 2) {
              streetAddress = parts[0];
              // Last part might be "City ST ZIP" or "City, ST ZIP"
              const lastPart = parts[parts.length - 1];
              const stateZipMatch = lastPart.match(/([A-Za-z\s]+)\s+([A-Z]{2})\s+(\d{5}(?:-\d{4})?)/);
              if (stateZipMatch) {
                city = stateZipMatch[1].trim();
                state = stateZipMatch[2].trim();
                zipcode = stateZipMatch[3].trim();
              } else {
                city = lastPart;
              }
            } else {
              streetAddress = fullAddress;
            }
          }
        } else {
          streetAddress = getValue('defendantStreetAddress', 'defendant-street-address', 'streetAddress', 'street_address', 'street-address');
          city = getValue('defendantCity', 'defendant-city', 'city', 'City');
          state = getValue('defendantState', 'defendant-state', 'state', 'State') || 'FL';
          zipcode = getValue('defendantZip', 'defendant-zipcode', 'zipcode', 'zip', 'ZIP', 'zip_code');
        }
        
        // Parse DOB - handle various formats
        let dob = getValue('defendantDOB', 'defendant-dob', 'dob', 'DOB', 'dateOfBirth', 'date_of_birth');
        if (dob) {
          // Convert MM/DD/YYYY to YYYY-MM-DD for date input
          if (dob.includes('/')) {
            const parts = dob.split('/');
            if (parts.length === 3) {
              const month = parts[0].padStart(2, '0');
              const day = parts[1].padStart(2, '0');
              let year = parts[2];
              if (year.length === 2) year = (parseInt(year) > 50 ? '19' : '20') + year;
              dob = `${year}-${month}-${day}`;
            }
          }
          // Remove any extra text like "US" after the date
          dob = dob.replace(/\s+[A-Z]+$/, '').trim();
        }
        
        // Set defendant fields with fallbacks
        const setField = (id, value) => {
          if (value) {
            const el = document.getElementById(id);
            if (el) el.value = value;
          }
        };
        
        setField('defendant-first-name', firstName);
        setField('defendant-middle-name', middleName);
        setField('defendant-last-name', lastName);
        setField('defendant-dob', dob);
        setField('defendant-street-address', streetAddress);
        setField('defendant-city', city);
        setField('defendant-state', state);
        setField('defendant-zipcode', zipcode);
        setField('defendant-booking-number', getValue('defendantArrestNumber', 'defendant-booking-number', 'bookingNumber', 'booking_number', 'booking-number', 'Number', 'arrestNumber', 'arrest_number'));
        setField('defendant-phone', getValue('defendant-phone', 'phone', 'Phone'));
        setField('defendant-email', getValue('defendant-email', 'email', 'Email'));
        setField('defendant-ssn', getValue('defendant-ssn', 'ssn', 'SSN', 'social_security'));
        setField('defendant-dl-number', getValue('defendant-dl-number', 'dlNumber', 'dl_number', 'driversLicense'));
        setField('defendant-arrest-date', getValue('defendant-arrest-date', 'arrestDate', 'arrest_date', 'bookedOn', 'booked_on'));
        setField('defendant-jail-facility', getValue('defendant-jail-facility', 'jailFacility', 'jail_facility', 'Housing', 'housing'));
        
        // Set race, sex, height, weight if available
        setField('defendant-race', getValue('defendantRace', 'race', 'Race'));
        setField('defendant-sex', getValue('defendantSex', 'sex', 'Sex'));
        setField('defendant-height', getValue('defendantHeight', 'height', 'Height'));
        setField('defendant-weight', getValue('defendantWeight', 'weight', 'Weight'));
        
        // Fill charges
        if (data.charges && Array.isArray(data.charges)) {
          document.getElementById('charges-container').innerHTML = '';
          chargeCount = 0;
          data.charges.forEach(charge => {
            addCharge({
              desc: charge.description || charge.desc || charge.charge || '',
              statute: charge.statute || charge.Statute || '',
              degree: charge.degree || charge.Degree || '',
              caseNumber: charge['case-number'] || charge.caseNumber || charge.case_number || charge['Case#'] || charge.caseNum || '',
              powerNumber: charge['power-number'] || charge.powerNumber || charge.power_number || '',
              bondAmount: charge['bond-amount'] || charge.bondAmount || charge.bond_amount || charge.Amount || charge.amount || ''
            });
          });
        }
        
        updateSummary();
        showToast('Booking data imported successfully!', 'success');
        switchTab(null, 'defendant');
        
      } catch (err) {
        console.error('Import error:', err);
        showToast('Error importing booking data: ' + err.message, 'error');
      }
    }

    /* =========================================================
       LOCAL STORAGE
       ========================================================= */
    function saveFormToLocalStorage() {
      const formData = collectFormData();
      localStorage.setItem(LS_KEY_FORM, JSON.stringify(formData));
      localStorage.setItem(LS_KEY_RECEIPT, currentReceiptNumber.toString());
    }

    function loadFormFromLocalStorage() {
      const saved = localStorage.getItem(LS_KEY_FORM);
      if (saved) {
        try {
          const data = JSON.parse(saved);
          // Restore defendant info
          Object.keys(data).forEach(key => {
            if (key.startsWith('defendant-')) {
              const el = document.getElementById(key);
              if (el) el.value = data[key] || '';
            }
          });
          
          // Restore charges
          if (data.charges && Array.isArray(data.charges)) {
            data.charges.forEach(charge => addCharge(charge));
          }
          
          // Restore indemnitors
          if (data.indemnitors && Array.isArray(data.indemnitors)) {
            data.indemnitors.forEach(ind => addIndemnitor(ind));
          }
          
          updateSummary();
        } catch (err) {
          console.error('Error loading saved form:', err);
        }
      }
    }

    function collectFormData() {
      const data = {};
      
      // Collect defendant fields
      document.querySelectorAll('[id^="defendant-"]').forEach(el => {
        if (el.tagName === 'INPUT' || el.tagName === 'SELECT') {
          data[el.id] = el.value;
        }
      });
      
      // Collect charges
      data.charges = [];
      document.querySelectorAll('.entity-card.charge').forEach(card => {
        const num = card.id.split('-')[1];
        data.charges.push({
          desc: document.getElementById(`charge-${num}-desc`)?.value || '',
          statute: document.getElementById(`charge-${num}-statute`)?.value || '',
          degree: document.getElementById(`charge-${num}-degree`)?.value || '',
          caseNumber: document.getElementById(`charge-${num}-case`)?.value || '',
          powerNumber: document.getElementById(`charge-${num}-power`)?.value || '',
          bondAmount: document.getElementById(`charge-${num}-bond`)?.value || '',
          bondType: document.getElementById(`charge-${num}-bond-type`)?.value || 'surety'
        });
      });
      
      // Collect indemnitors
      data.indemnitors = [];
      document.querySelectorAll('.entity-card.indemnitor').forEach(card => {
        const num = card.id.split('-')[1];
        data.indemnitors.push({
          firstName: document.getElementById(`indemnitor-${num}-first`)?.value || '',
          middleName: document.getElementById(`indemnitor-${num}-middle`)?.value || '',
          lastName: document.getElementById(`indemnitor-${num}-last`)?.value || '',
          relationship: document.getElementById(`indemnitor-${num}-relationship`)?.value || '',
          dob: document.getElementById(`indemnitor-${num}-dob`)?.value || '',
          ssn: document.getElementById(`indemnitor-${num}-ssn`)?.value || '',
          dl: document.getElementById(`indemnitor-${num}-dl`)?.value || '',
          dlState: document.getElementById(`indemnitor-${num}-dl-state`)?.value || 'FL',
          address: document.getElementById(`indemnitor-${num}-address`)?.value || '',
          city: document.getElementById(`indemnitor-${num}-city`)?.value || '',
          zip: document.getElementById(`indemnitor-${num}-zip`)?.value || '',
          phone: document.getElementById(`indemnitor-${num}-phone`)?.value || '',
          email: document.getElementById(`indemnitor-${num}-email`)?.value || '',
          employer: document.getElementById(`indemnitor-${num}-employer`)?.value || '',
          employerPhone: document.getElementById(`indemnitor-${num}-employer-phone`)?.value || ''
        });
      });
      
      return data;
    }

    function confirmClearAll() {
      if (confirm('Are you sure you want to clear all form data? This cannot be undone.')) {
        clearAllFields();
      }
    }

    function clearAllFields() {
      // Clear all inputs
      document.querySelectorAll('input, select, textarea').forEach(el => {
        if (el.type === 'checkbox') {
          // Keep default docs checked
        } else {
          el.value = '';
        }
      });
      
      // Clear charges and indemnitors
      document.getElementById('charges-container').innerHTML = '';
      document.getElementById('indemnitors-container').innerHTML = '';
      chargeCount = 0;
      indemnitorCount = 0;
      
      // Show empty messages
      document.getElementById('no-charges-message').style.display = 'block';
      document.getElementById('no-indemnitors-message').style.display = 'block';
      document.getElementById('bond-summary').style.display = 'none';
      
      // Reset summary displays to clean defaults (prevents erroneous characters)
      const summaryDefendant = document.getElementById('summary-defendant');
      const summaryBond = document.getElementById('summary-bond');
      const summaryCharges = document.getElementById('summary-charges');
      const totalChargesCount = document.getElementById('total-charges-count');
      const totalBondAmount = document.getElementById('total-bond-amount');
      const premiumAmount = document.getElementById('premium-amount');
      const bondWritten = document.getElementById('bond-written');
      const paymentTotalBond = document.getElementById('payment-total-bond');
      const paymentPremiumDue = document.getElementById('payment-premium-due');
      const paymentDown = document.getElementById('payment-down');
      const paymentBalance = document.getElementById('payment-balance');
      const paymentPremiumWords = document.getElementById('payment-premium-words');
      
      if (summaryDefendant) summaryDefendant.textContent = '--';
      if (summaryBond) summaryBond.textContent = '$0.00';
      if (summaryCharges) summaryCharges.textContent = '0';
      if (totalChargesCount) totalChargesCount.textContent = '0';
      if (totalBondAmount) totalBondAmount.textContent = '$0.00';
      if (premiumAmount) premiumAmount.textContent = '$0.00';
      if (bondWritten) bondWritten.textContent = 'Zero and 00/100 Dollars';
      if (paymentTotalBond) paymentTotalBond.textContent = '$0.00';
      if (paymentPremiumDue) paymentPremiumDue.textContent = '$0.00';
      if (paymentDown) paymentDown.textContent = '$0.00';
      if (paymentBalance) paymentBalance.textContent = '$0.00';
      if (paymentPremiumWords) paymentPremiumWords.textContent = 'Zero and 00/100 Dollars';
      
      // Reset receipt number display
      updateReceiptDisplay();
      
      updateBadges();
      localStorage.removeItem(LS_KEY_FORM);
      showToast('All fields cleared', 'info');
    }

    /* =========================================================
       PDF GENERATION & SIGNNOW
       ========================================================= */
    /**
     * Upload PDF to SignNow
     */
    async function uploadToSignNow(pdfBytes, formData) {
      const defendantName = `${formData['defendant-first-name'] || ''}_${formData['defendant-last-name'] || ''}`.trim();
      const filename = `Bail_Packet_${defendantName}_${Date.now()}.pdf`;
      
      const uploadFormData = new FormData();
      const pdfBlob = new Blob([pdfBytes], { type: 'application/pdf' });
      uploadFormData.append('file', pdfBlob, filename);
      
      try {
        const response = await fetch(`${CONFIG.signNowApiBase}/document`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${CONFIG.signNowToken}`,
            'Accept': 'application/json'
          },
          body: uploadFormData
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('SignNow upload error:', errorText);
          throw new Error(`SignNow upload failed: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('SignNow upload result:', result);
        return result.id;
      } catch (err) {
        console.error('SignNow upload error:', err);
        throw err;
      }
    }

    /**
     * Send signing invite via SignNow
     */
    async function sendSignNowInvite(documentId, formData) {
      const defendantEmail = document.getElementById('signer-defendant-email').value;
      const indemnitorEmail = document.getElementById('signer-indemnitor-email').value;
      const emailSubject = document.getElementById('email-subject').value || 'Shamrock Bail Bonds - Documents for Signature';
      
      const invitePayload = {
        to: [],
        from: 'admin@shamrockbailbonds.biz',
        subject: emailSubject,
        message: `Please review and sign the bail bond documents for ${formData['defendant-first-name']} ${formData['defendant-last-name']}.`
      };
      
      let order = 1;
      
      if (defendantEmail) {
        invitePayload.to.push({
          email: defendantEmail,
          role: 'Defendant',
          role_id: '',
          order: order++,
          reassign: '0',
          decline_by_signature: '0',
          reminder: 4,
          expiration_days: 30,
          subject: emailSubject,
          message: `Dear ${formData['defendant-first-name']}, please sign the bail bond documents.`
        });
      }
      
      if (indemnitorEmail) {
        invitePayload.to.push({
          email: indemnitorEmail,
          role: 'Indemnitor',
          role_id: '',
          order: order++,
          reassign: '0',
          decline_by_signature: '0',
          reminder: 4,
          expiration_days: 30,
          subject: emailSubject,
          message: 'Please sign the bail bond documents as the indemnitor/co-signer.'
        });
      }
      
      const additionalEmails = document.querySelectorAll('#additional-signer-emails input[type="email"]');
      additionalEmails.forEach((input, index) => {
        if (input.value) {
          invitePayload.to.push({
            email: input.value,
            role: `Additional Signer ${index + 1}`,
            role_id: '',
            order: order++,
            reassign: '0',
            decline_by_signature: '0',
            reminder: 4,
            expiration_days: 30
          });
        }
      });
      
      const response = await fetch(`${CONFIG.signNowApiBase}/document/${documentId}/invite`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${CONFIG.signNowToken}`,
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify(invitePayload)
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error('SignNow invite error:', errorText);
        throw new Error(`SignNow invite failed: ${response.status}`);
      }
      
      const result = await response.json();
      console.log('SignNow invite result:', result);
      return { success: true, inviteId: result.id, mode: 'email' };
    }

    /**
     * Create a signing link for kiosk mode
     */
    async function createSigningLink(documentId) {
      const response = await fetch(`${CONFIG.signNowApiBase}/link`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${CONFIG.signNowToken}`,
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({ document_id: documentId })
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error('SignNow link error:', errorText);
        throw new Error(`SignNow link creation failed: ${response.status}`);
      }
      
      const result = await response.json();
      console.log('SignNow link result:', result);
      return { success: true, signingLink: result.url, mode: 'kiosk' };
    }

    /**
     * Download filled PDF directly
     */
    function downloadFilledPdf(pdfBytes, formData) {
      const defendantName = `${formData['defendant-first-name'] || 'Unknown'}_${formData['defendant-last-name'] || 'Defendant'}`;
      const filename = `Bail_Packet_${defendantName}_${new Date().toISOString().split('T')[0]}.pdf`;
      
      const blob = new Blob([pdfBytes], { type: 'application/pdf' });
      const url = URL.createObjectURL(blob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      link.click();
      
      setTimeout(() => URL.revokeObjectURL(url), 1000);
    }

    /**
     * Show success result after sending
     */
    function showSuccessResult(result, formData, signingMethod) {
      const resultDiv = document.getElementById('generate-result');
      const defendantName = `${formData['defendant-first-name']} ${formData['defendant-last-name']}`;
      
      let content = '';
      
      if (signingMethod === 'email') {
        content = `
          <div style="background: var(--success-bg); border: 2px solid var(--success); border-radius: var(--radius); padding: 24px; text-align: center;">
            <p style="font-size: 48px; margin-bottom: 16px;"></p>
            <h4 style="color: var(--success); margin-bottom: 8px;">Packet Sent Successfully!</h4>
            <p style="color: var(--text-secondary);">Receipt #${currentReceiptNumber - 1}  ${defendantName}</p>
            <p style="margin-top: 12px; color: var(--muted);">Signing invites have been sent to the specified email addresses.</p>
            <p style="margin-top: 16px;"><button class="btn btn-secondary" onclick="switchTab(null, 'status')">View Status</button></p>
          </div>
        `;
        showToast('Bail packet sent to SignNow successfully!', 'success');
      } else if (signingMethod === 'kiosk' && result.signingLink) {
        content = `
          <div style="background: var(--success-bg); border: 2px solid var(--success); border-radius: var(--radius); padding: 24px; text-align: center;">
            <p style="font-size: 48px; margin-bottom: 16px;"></p>
            <h4 style="color: var(--success); margin-bottom: 8px;">Kiosk Signing Ready!</h4>
            <p style="color: var(--text-secondary);">Receipt #${currentReceiptNumber - 1}  ${defendantName}</p>
            <p style="margin-top: 16px;"><a href="${result.signingLink}" target="_blank" class="btn btn-success btn-lg">Open Signing Page</a></p>
            <p style="margin-top: 12px;"><input type="text" value="${result.signingLink}" readonly style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border);" onclick="this.select()"></p>
          </div>
        `;
        showToast('Kiosk signing link created!', 'success');
      } else {
        content = `
          <div style="background: var(--success-bg); border: 2px solid var(--success); border-radius: var(--radius); padding: 24px; text-align: center;">
            <p style="font-size: 48px; margin-bottom: 16px;"></p>
            <h4 style="color: var(--success); margin-bottom: 8px;">Packet Downloaded!</h4>
            <p style="color: var(--text-secondary);">Receipt #${currentReceiptNumber - 1}  ${defendantName}</p>
            <p style="margin-top: 12px; color: var(--muted);">The filled bail packet has been downloaded to your device.</p>
          </div>
        `;
        showToast('Bail packet downloaded!', 'success');
      }
      
      resultDiv.innerHTML = content;
    }

    /**
     * Generate bail packet and send to SignNow
     */
    async function generateAndSend() {
      const formData = collectFormData();
      
      if (!formData['defendant-first-name'] || !formData['defendant-last-name']) {
        showToast('Please enter defendant name', 'error');
        return;
      }
      
      if (formData.charges.length === 0) {
        showToast('Please add at least one charge', 'error');
        return;
      }
      
      const signingMethod = document.getElementById('signing-method').value;
      
      if (signingMethod === 'email') {
        const defendantEmail = document.getElementById('signer-defendant-email').value;
        const indemnitorEmail = document.getElementById('signer-indemnitor-email').value;
        if (!defendantEmail && !indemnitorEmail) {
          showToast('Please enter at least one email address for signing', 'error');
          return;
        }
      }
      
      showProgress('Generating Bail Packet', [
        'Collecting form data',
        'Fetching PDF templates',
        'Filling documents',
        'Merging packet',
        'Uploading to SignNow',
        'Sending for signatures'
      ]);
      
      try {
        updateProgress(1, 'Collecting form data...');
        await sleep(300);
        
        updateProgress(2, 'Fetching PDF templates from Google Drive...');
        const selectedDocs = getSelectedDocuments();
        if (selectedDocs.length === 0) throw new Error('No documents selected');
        
        const pdfBytes = await fetchPDFsFromDrive(selectedDocs);
        
        updateProgress(3, 'Filling documents with defendant data...');
        const filledPdfs = await fillPDFsWithData(pdfBytes, formData);
        
        updateProgress(4, 'Merging all documents into packet...');
        const mergedPdf = await mergePDFs(filledPdfs);
        
        updateProgress(5, 'Uploading to SignNow...');
        const documentId = await uploadToSignNow(mergedPdf, formData);
        
        if (!documentId) throw new Error('Failed to upload document to SignNow');
        
        updateProgress(6, 'Sending for signatures...');
        
        let result;
        if (signingMethod === 'email') {
          result = await sendSignNowInvite(documentId, formData);
        } else if (signingMethod === 'kiosk') {
          result = await createSigningLink(documentId);
        } else {
          result = { success: true, mode: 'download' };
          downloadFilledPdf(mergedPdf, formData);
        }
        
        currentReceiptNumber++;
        updateReceiptDisplay();
        saveFormToLocalStorage();
        
        sentPackets.push({
          id: Date.now(),
          documentId: documentId,
          defendant: `${formData['defendant-first-name']} ${formData['defendant-last-name']}`,
          date: new Date().toISOString(),
          status: signingMethod === 'download' ? 'downloaded' : 'sent',
          receiptNumber: currentReceiptNumber - 1,
          signingMethod: signingMethod
        });
        localStorage.setItem(LS_KEY_PACKETS, JSON.stringify(sentPackets));
        
        hideProgress();
        showSuccessResult(result, formData, signingMethod);
        
      } catch (err) {
        hideProgress();
        showToast('Error generating packet: ' + err.message, 'error');
        console.error('Generation error:', err);
      }
    }

    /* =========================================================
       PDF PREVIEW FUNCTIONALITY
       ========================================================= */
    
    /**
     * Get selected documents in the correct order for SignNow
     * Excludes print-only documents (like appearance-bond)
     * @returns {Array} Array of document objects sorted by templateOrder
     */
    function getSelectedDocuments() {
      const selected = [];
      const checkedTemplates = new Set();
      
      // First, collect all checked templates
      document.querySelectorAll('.doc-item input[type="checkbox"]:checked').forEach(cb => {
        const templateKey = cb.dataset.template;
        if (templateKey && CONFIG.templates[templateKey]) {
          checkedTemplates.add(templateKey);
        }
      });
      
      // Then, add documents in the correct order from templateOrder
      // Exclude print-only documents
      CONFIG.templateOrder.forEach(templateKey => {
        if (checkedTemplates.has(templateKey) && !CONFIG.printOnlyDocs.includes(templateKey)) {
          const cb = document.querySelector(`input[data-template="${templateKey}"]`);
          selected.push({
            key: templateKey,
            id: CONFIG.templates[templateKey],
            name: cb?.closest('.doc-item')?.querySelector('.doc-name')?.textContent || templateKey
          });
        }
      });
      
      return selected;
    }
    
    /**
     * Get print-only documents (like appearance bonds)
     * These are generated but not sent to SignNow
     * @returns {Array} Array of print-only document objects
     */
    function getPrintOnlyDocuments() {
      const printOnly = [];
      
      CONFIG.printOnlyDocs.forEach(templateKey => {
        const cb = document.querySelector(`input[data-template="${templateKey}"]:checked`);
        if (cb && CONFIG.templates[templateKey]) {
          printOnly.push({
            key: templateKey,
            id: CONFIG.templates[templateKey],
            name: cb.closest('.doc-item')?.querySelector('.doc-name')?.textContent || templateKey
          });
        }
      });
      
      return printOnly;
    }

    /**
     * Fetch PDFs from Google Drive via GAS backend
     * Uses google.script.run for reliable server-side execution (avoids CORS)
     */
    async function fetchPDFsFromDrive(documents) {
      const results = [];
      
      // Helper function to wrap google.script.run in a Promise
      function fetchPdfViaGAS(fileId) {
        return new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .getPdfByFileId(fileId);
        });
      }
      
      for (const doc of documents) {
        try {
          console.log(`Fetching ${doc.key} (${doc.id})...`);
          
          // Use google.script.run for server-side PDF fetching (most reliable)
          const data = await fetchPdfViaGAS(doc.id);
          
          if (data && data.success && data.pdfBase64) {
            const binaryString = atob(data.pdfBase64);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
              bytes[i] = binaryString.charCodeAt(i);
            }
            results.push({ key: doc.key, name: doc.name, bytes: bytes });
            console.log(` Successfully fetched ${doc.key}`);
            continue;
          } else if (data && data.error) {
            console.warn(`GAS returned error for ${doc.key}: ${data.error}`);
          }
          
          // Fallback: Try fetch API to GAS web app URL
          console.warn(`google.script.run failed for ${doc.key}, trying fetch...`);
          try {
            const response = await fetch(`${CONFIG.gasWebAppUrl}?action=getPdf&fileId=${doc.id}`, {
              method: 'GET',
              headers: { 'Accept': 'application/json' }
            });
            
            if (response.ok) {
              const fetchData = await response.json();
              if (fetchData.success && fetchData.pdfBase64) {
                const binaryString = atob(fetchData.pdfBase64);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                  bytes[i] = binaryString.charCodeAt(i);
                }
                results.push({ key: doc.key, name: doc.name, bytes: bytes });
                console.log(` Fetched ${doc.key} via fetch API`);
                continue;
              }
            }
          } catch (fetchErr) {
            console.warn(`Fetch API also failed for ${doc.key}:`, fetchErr);
          }
          
        } catch (err) {
          console.error(`Failed to fetch ${doc.key}:`, err);
        }
      }
      
      if (results.length === 0) {
        throw new Error('Could not fetch any PDF templates. Check GAS deployment and file permissions. Open browser console (F12) for details.');
      }
      return results;
    }

    /**
     * Map field names to form data values
     */
    function mapFieldToData(fieldName, formData) {
      const mappings = {
        'defendant-name': `${formData['defendant-first-name'] || ''} ${formData['defendant-middle-name'] || ''} ${formData['defendant-last-name'] || ''}`.trim().replace(/\s+/g, ' '),
        'defendant-full-name': `${formData['defendant-first-name'] || ''} ${formData['defendant-middle-name'] || ''} ${formData['defendant-last-name'] || ''}`.trim().replace(/\s+/g, ' '),
        'name': `${formData['defendant-first-name'] || ''} ${formData['defendant-last-name'] || ''}`.trim(),
        'first-name': formData['defendant-first-name'],
        'last-name': formData['defendant-last-name'],
        'dob': formData['defendant-dob'],
        'ssn': formData['defendant-ssn'],
        'dl': formData['defendant-dl'],
        'address': formData['defendant-address'],
        'city': formData['defendant-city'],
        'state': formData['defendant-state'] || 'FL',
        'zip': formData['defendant-zip'],
        'phone': formData['defendant-phone'],
        'email': formData['defendant-email'],
        'bond-amount': calculateTotalBondAmount(formData),
        'total-bond': calculateTotalBondAmount(formData),
        'premium-amount': calculatePremiumAmount(formData),
        'premium': calculatePremiumAmount(formData),
        'receipt-number': currentReceiptNumber.toString(),
        'collateral-receipt-number': `C-${currentReceiptNumber}`,
        'date': new Date().toLocaleDateString('en-US'),
        'today': new Date().toLocaleDateString('en-US'),
        'current-date': new Date().toISOString().split('T')[0]
      };
      
      if (fieldName.includes('charge') && formData.charges && formData.charges.length > 0) {
        const chargeMatch = fieldName.match(/charge-?(\d+)?-?(.*)?/);
        if (chargeMatch) {
          const chargeIndex = parseInt(chargeMatch[1] || '1') - 1;
          const chargeField = chargeMatch[2] || 'desc';
          if (formData.charges[chargeIndex]) {
            const charge = formData.charges[chargeIndex];
            if (chargeField === 'desc' || chargeField === 'description') return charge.desc;
            if (chargeField === 'case' || chargeField === 'case-number') return charge.caseNumber;
            if (chargeField === 'power' || chargeField === 'power-number') return charge.powerNumber;
            if (chargeField === 'bond' || chargeField === 'bond-amount') return charge.bondAmount;
          }
        }
      }
      return mappings[fieldName] || null;
    }

    function calculateTotalBondAmount(formData) {
      if (!formData.charges || formData.charges.length === 0) return '0.00';
      const total = formData.charges.reduce((sum, charge) => {
        const amount = parseFloat(charge.bondAmount?.replace(/[,$]/g, '') || 0);
        return sum + amount;
      }, 0);
      return total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    /**
     * Calculate premium amount for PDF filling
     * Applies $100 minimum per charge rule:
     * - If charge bond <= $1,000: Premium = $100
     * - If charge bond > $1,000: Premium = 10%
     */
    function calculatePremiumAmount(formData) {
      if (!formData.charges || formData.charges.length === 0) return '0.00';
      
      let totalPremium = 0;
      formData.charges.forEach(charge => {
        const bondAmount = parseFloat(charge.bondAmount?.replace(/[,$]/g, '') || 0);
        if (bondAmount > 0) {
          // Apply $100 minimum per charge (for bonds $1,000 or less)
          if (bondAmount <= 1000) {
            totalPremium += 100;
          } else {
            totalPremium += bondAmount * 0.10;
          }
        }
      });
      
      return totalPremium.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    /**
     * Fill PDFs with form data using pdf-lib
     */
    async function fillPDFsWithData(pdfDocs, formData) {
      const { PDFDocument } = PDFLib;
      const filledPdfs = [];
      
      for (const doc of pdfDocs) {
        try {
          const pdfDoc = await PDFDocument.load(doc.bytes);
          const form = pdfDoc.getForm();
          const fields = form.getFields();
          
          for (const field of fields) {
            const fieldName = field.getName();
            const fieldNameLower = fieldName.toLowerCase().replace(/[_\s]/g, '-');
            
            let value = formData[fieldNameLower] || formData[`defendant-${fieldNameLower}`] || mapFieldToData(fieldNameLower, formData);
            
            if (value !== null && value !== undefined && value !== '') {
              try {
                if (field.constructor.name === 'PDFTextField') {
                  field.setText(String(value));
                } else if (field.constructor.name === 'PDFCheckBox') {
                  if (value === true || value === 'true' || value === 'yes' || value === '1') field.check();
                } else if (field.constructor.name === 'PDFDropdown') {
                  field.select(String(value));
                }
              } catch (fieldErr) {
                console.warn(`Could not set field ${fieldName}:`, fieldErr);
              }
            }
          }
          
          const filledBytes = await pdfDoc.save();
          filledPdfs.push({ key: doc.key, name: doc.name, bytes: filledBytes });
        } catch (err) {
          console.error(`Error filling ${doc.key}:`, err);
          filledPdfs.push(doc);
        }
      }
      return filledPdfs;
    }

    /**
     * Merge multiple PDFs into one
     */
    async function mergePDFs(pdfDocs) {
      const { PDFDocument } = PDFLib;
      const mergedPdf = await PDFDocument.create();
      
      for (const doc of pdfDocs) {
        try {
          const pdf = await PDFDocument.load(doc.bytes);
          const pages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
          pages.forEach(page => mergedPdf.addPage(page));
        } catch (err) {
          console.error(`Error merging ${doc.key}:`, err);
        }
      }
      return await mergedPdf.save();
    }

    /**
     * Show preview modal with PDF viewer
     */
    function showPreviewModal(pdfUrl, formData) {
      const existingModal = document.getElementById('preview-modal');
      if (existingModal) existingModal.remove();
      
      const defendantName = `${formData['defendant-first-name'] || ''} ${formData['defendant-last-name'] || ''}`.trim();
      
      const modal = document.createElement('div');
      modal.id = 'preview-modal';
      modal.innerHTML = `
        <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:10001;display:flex;align-items:center;justify-content:center;padding:20px;">
          <div style="background:var(--surface);border-radius:var(--radius-lg);width:100%;max-width:1200px;height:90vh;display:flex;flex-direction:column;overflow:hidden;box-shadow:var(--shadow);">
            <div style="padding:20px 24px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px;">
              <h3 style="margin:0;font-size:18px;"> Bail Packet Preview - ${defendantName}</h3>
              <div style="display:flex;gap:12px;flex-wrap:wrap;">
                <button class="btn btn-secondary" onclick="downloadPreviewPdf()"> Download PDF</button>
                <button class="btn btn-success" onclick="closePreviewAndSend()"> Looks Good - Send to SignNow</button>
                <button class="btn btn-danger" onclick="closePreviewModal()"> Close</button>
              </div>
            </div>
            <div style="flex:1;overflow:hidden;">
              <iframe id="preview-iframe" src="${pdfUrl}" style="width:100%;height:100%;border:none;"></iframe>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      window.currentPreviewPdfUrl = pdfUrl;
    }

    function closePreviewModal() {
      const modal = document.getElementById('preview-modal');
      if (modal) {
        if (window.currentPreviewPdfUrl) {
          URL.revokeObjectURL(window.currentPreviewPdfUrl);
          window.currentPreviewPdfUrl = null;
        }
        modal.remove();
      }
    }

    function downloadPreviewPdf() {
      if (window.currentPreviewPdfUrl) {
        const formData = collectFormData();
        const defendantName = `${formData['defendant-first-name'] || 'Unknown'}_${formData['defendant-last-name'] || 'Defendant'}`;
        const filename = `Bail_Packet_${defendantName}_${new Date().toISOString().split('T')[0]}.pdf`;
        const link = document.createElement('a');
        link.href = window.currentPreviewPdfUrl;
        link.download = filename;
        link.click();
      }
    }

    function closePreviewAndSend() {
      closePreviewModal();
      generateAndSend();
    }

    /**
     * Preview the bail packet
     */
    async function previewPacket() {
      const formData = collectFormData();
      
      if (!formData['defendant-first-name'] || !formData['defendant-last-name']) {
        showToast('Please enter defendant name before preview', 'error');
        return;
      }
      
      showProgress('Generating Preview', [
        'Collecting form data',
        'Fetching PDF templates',
        'Filling documents',
        'Rendering preview'
      ]);
      
      try {
        updateProgress(1, 'Collecting form data...');
        await sleep(300);
        
        updateProgress(2, 'Fetching PDF templates from Google Drive...');
        const selectedDocs = getSelectedDocuments();
        if (selectedDocs.length === 0) throw new Error('No documents selected');
        
        const pdfBytes = await fetchPDFsFromDrive(selectedDocs);
        
        updateProgress(3, 'Filling documents with form data...');
        const filledPdfs = await fillPDFsWithData(pdfBytes, formData);
        
        updateProgress(4, 'Rendering preview...');
        const mergedPdf = await mergePDFs(filledPdfs);
        
        const pdfBlob = new Blob([mergedPdf], { type: 'application/pdf' });
        const pdfUrl = URL.createObjectURL(pdfBlob);
        
        hideProgress();
        showPreviewModal(pdfUrl, formData);
        
      } catch (err) {
        hideProgress();
        showToast('Error generating preview: ' + err.message, 'error');
        console.error('Preview error:', err);
      }
    }

    function toggleSigningOptions() {
      const method = document.getElementById('signing-method').value;
      const emailSection = document.getElementById('email-recipients-section');
      const generateBtn = document.getElementById('generate-btn');
      
      if (method === 'email') {
        emailSection.style.display = 'block';
        generateBtn.textContent = '&#9654; Generate & Send to SignNow';
      } else if (method === 'kiosk') {
        emailSection.style.display = 'none';
        generateBtn.textContent = '&#128421; Generate for Kiosk Signing';
      } else {
        emailSection.style.display = 'none';
        generateBtn.textContent = '&#8595; Download Packet';
      }
    }

    function addSignerEmail() {
      const container = document.getElementById('additional-signer-emails');
      const count = container.children.length + 3;
      container.insertAdjacentHTML('beforeend', `
        <div class="form-row" style="margin-top: 12px;">
          <div class="form-group">
            <label>Additional Signer ${count - 2}</label>
            <input type="email" placeholder="signer@email.com">
          </div>
          <div class="form-group" style="align-self: flex-end;">
            <button class="btn btn-danger btn-sm" onclick="this.closest('.form-row').remove()">Remove</button>
          </div>
        </div>
      `);
    }

    /* =========================================================
       PROGRESS OVERLAY
       ========================================================= */
    function showProgress(title, steps) {
      document.getElementById('progress-title').textContent = title;
      document.getElementById('progress-fill').style.width = '0%';
      document.getElementById('progress-message').textContent = 'Initializing...';
      
      const stepsHtml = steps.map((step, i) => `
        <div class="progress-step" id="progress-step-${i + 1}">
          <span class="step-icon">${i + 1}</span>
          <span>${step}</span>
        </div>
      `).join('');
      document.getElementById('progress-steps').innerHTML = stepsHtml;
      
      document.getElementById('progress-overlay').classList.add('active');
    }

    function updateProgress(step, message) {
      const totalSteps = document.querySelectorAll('.progress-step').length;
      const percent = (step / totalSteps) * 100;
      
      document.getElementById('progress-fill').style.width = `${percent}%`;
      document.getElementById('progress-message').textContent = message;
      
      // Update step indicators
      document.querySelectorAll('.progress-step').forEach((el, i) => {
        el.classList.remove('active', 'complete');
        if (i + 1 < step) el.classList.add('complete');
        else if (i + 1 === step) el.classList.add('active');
      });
    }

    function hideProgress() {
      document.getElementById('progress-overlay').classList.remove('active');
    }

    /* =========================================================
       TOAST NOTIFICATIONS
       ========================================================= */
    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      const icons = { success: '', error: '', warning: '', info: '' };
      
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `
        <span class="toast-icon">${icons[type]}</span>
        <span class="toast-message">${message}</span>
        <button class="toast-close" onclick="this.parentElement.remove()"></button>
      `;
      
      container.appendChild(toast);
      
      // Auto-remove after 5 seconds
      setTimeout(() => toast.remove(), 5000);
    }

    /* =========================================================
       KEYBOARD SHORTCUTS
       ========================================================= */
    function setupKeyboardShortcuts() {
      document.addEventListener('keydown', function(e) {
        // Ctrl+S - Save
        if (e.ctrlKey && e.key === 's') {
          e.preventDefault();
          saveFormToLocalStorage();
          showToast('Form saved!', 'success');
        }
        
        // Ctrl+Shift+X - Clear all
        if (e.ctrlKey && e.shiftKey && e.key === 'X') {
          e.preventDefault();
          confirmClearAll();
        }
        
        // ? - Show shortcuts
        if (e.key === '?' && !e.ctrlKey && !e.altKey) {
          showKeyboardShortcuts();
        }
        
        // Alt+1-8 - Switch tabs
        if (e.altKey && e.key >= '1' && e.key <= '8') {
          e.preventDefault();
          const tabs = ['scrapers', 'charges', 'defendant', 'indemnitors', 'payment', 'documents', 'generate', 'status'];
          const tabId = tabs[parseInt(e.key) - 1];
          if (tabId) switchTab(null, tabId);
        }
        
        // Ctrl+D - Toggle dark mode
        if (e.ctrlKey && e.key === 'd') {
          e.preventDefault();
          toggleMode();
        }
      });
    }

    function showKeyboardShortcuts() {
      showToast('Keyboard shortcuts: Ctrl+S (Save), Ctrl+Shift+X (Clear), Alt+1-8 (Tabs), Ctrl+D (Dark mode)', 'info');
    }

    /* =========================================================
       UTILITIES
       ========================================================= */
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    /**
     * Get status badge HTML
     */
    function getStatusBadge(status) {
      const badges = {
        'sent': '<span style="background: #e3f2fd; color: #1976d2; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">Sent</span>',
        'viewed': '<span style="background: #fff3e0; color: #f57c00; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">Viewed</span>',
        'signed': '<span style="background: #e8f5e9; color: #388e3c; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">Signed</span>',
        'downloaded': '<span style="background: #9e9e9e; color: #fff; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">Downloaded</span>',
        'expired': '<span style="background: #ffebee; color: #d32f2f; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">Expired</span>'
      };
      return badges[status] || badges['sent'];
    }

    /**
     * Check document status from SignNow
     */
    async function checkDocumentStatus(documentId) {
      try {
        const response = await fetch(`${CONFIG.signNowApiBase}/document/${documentId}`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${CONFIG.signNowToken}`,
            'Accept': 'application/json'
          }
        });
        
        if (!response.ok) throw new Error(`Failed to get document status: ${response.status}`);
        
        const doc = await response.json();
        console.log('Document status:', doc);
        
        const packet = sentPackets.find(p => p.documentId === documentId);
        if (packet) {
          if (doc.signatures && doc.signatures.length > 0) {
            packet.status = 'signed';
          } else if (doc.viewed_at) {
            packet.status = 'viewed';
          }
          localStorage.setItem(LS_KEY_PACKETS, JSON.stringify(sentPackets));
          refreshStatus();
        }
        
        showToast('Status updated', 'success');
      } catch (err) {
        console.error('Status check error:', err);
        showToast('Error checking status: ' + err.message, 'error');
      }
    }

    /**
     * Refresh status from SignNow
     */
    async function refreshStatus() {
      showToast('Refreshing status...', 'info');
      
      const statusContainer = document.getElementById('status-container');
      
      if (sentPackets.length === 0) {
        statusContainer.innerHTML = `
          <div style="text-align: center; padding: 48px; color: var(--muted);">
            <p style="font-size: 48px; margin-bottom: 16px;"></p>
            <p style="font-size: 16px; font-weight: 600;">No packets sent yet</p>
            <p style="font-size: 14px; margin-top: 8px;">Generate and send a packet to see status here</p>
          </div>
        `;
        return;
      }
      
      let html = `
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="border-bottom: 2px solid var(--border);">
              <th style="text-align: left; padding: 12px;">Receipt #</th>
              <th style="text-align: left; padding: 12px;">Defendant</th>
              <th style="text-align: left; padding: 12px;">Date</th>
              <th style="text-align: left; padding: 12px;">Method</th>
              <th style="text-align: left; padding: 12px;">Status</th>
              <th style="text-align: left; padding: 12px;">Actions</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      for (const packet of sentPackets.slice().reverse()) {
        const statusBadge = getStatusBadge(packet.status);
        const date = new Date(packet.date).toLocaleDateString('en-US', {
          month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit'
        });
        
        html += `
          <tr style="border-bottom: 1px solid var(--border);">
            <td style="padding: 12px; font-family: monospace;">${packet.receiptNumber}</td>
            <td style="padding: 12px; font-weight: 600;">${packet.defendant}</td>
            <td style="padding: 12px; color: var(--muted);">${date}</td>
            <td style="padding: 12px;">${packet.signingMethod || 'email'}</td>
            <td style="padding: 12px;">${statusBadge}</td>
            <td style="padding: 12px;">
              ${packet.documentId ? `<button class="btn btn-secondary btn-sm" onclick="checkDocumentStatus('${packet.documentId}')">Check</button>` : '-'}
            </td>
          </tr>
        `;
      }
      
      html += '</tbody></table>';
      statusContainer.innerHTML = html;
    }

    // Auto-save every 30 seconds
    setInterval(saveFormToLocalStorage, 30000);
  </script>
</body>
</html>
